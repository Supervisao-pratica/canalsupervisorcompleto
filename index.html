<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Portal do Supervisor da Prática - Senac PR</title>
    
    <!-- 1. BIBLIOTECAS (Tailwind, Lucide, SheetJS, ChartJS) -->
    <!-- Google Generative AI (Gemini) Library -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false, // CRUCIAL: Impede que o Tailwind quebre o design do site original
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 2. ÍCONES E FONTES DO SITE ORIGINAL -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILO DO SITE ORIGINAL (Preservado)
           ========================================= */
        :root {
            --senac-blue: #004587;
            --senac-dark-blue: #003366;
            --senac-orange: #F68B1F;
            --senac-green: #16a34a;
            --bg-color: #f8fafc;
            --text-color: #374151;
            --border-color: #e5e7eb;
            --white: #ffffff;
            --senac-light-blue: #0056a3;
        }

        /* Reset manual para garantir compatibilidade */
        body { font-family: 'Roboto', 'Segoe UI', 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.5; overflow-y: auto; height: 100vh; display: flex; flex-direction: column; }
        body.locked { overflow: hidden !important; }
        
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; padding: 0; margin: 0; }
        img { max-width: 100%; display: block; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .hidden-section { display: none !important; }

        /* TELA DE LOGIN PRINCIPAL (SITE) */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--senac-blue), var(--senac-dark-blue)); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 50px 40px; border-radius: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); width: 90%; max-width: 400px; text-align: center; }
        .login-title { color: var(--senac-blue); margin-bottom: 10px; font-size: 1.5rem; font-weight: bold; }
        .login-desc { color: #666; font-size: 14px; margin-bottom: 30px; }
        .password-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px; outline: none; margin-bottom: 20px; }
        .password-input:focus { border-color: var(--senac-orange); }
        .btn-primary { width: 100%; background-color: var(--senac-orange); color: white; font-weight: bold; padding: 14px; border-radius: 6px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-primary:hover { background-color: #d97706; }

        /* NAVBAR SITE */
        .navbar { background-color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 90; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; height: 80px; }
        .logo-area { display: flex; align-items: center; }
        .logo-area img { height: 40px; margin-right: 15px; }
        .logo-text { font-size: 1.125rem; font-weight: bold; color: var(--senac-blue); border-left: 1px solid #ddd; padding-left: 15px; }
        .nav-links { display: flex; gap: 5px; }
        .nav-btn { padding: 26px 15px; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-btn:hover { color: var(--senac-blue); }
        .nav-btn.active { color: var(--senac-blue); border-bottom-color: var(--senac-orange); }
        .blackboard-btn { background-color: var(--senac-blue); color: white !important; padding: 10px 20px; border-radius: 6px; font-weight: 500; font-size: 0.875rem; text-decoration: none; }
        .logout-btn { color: #dc2626; font-weight: bold; font-size: 0.875rem; padding: 10px; border: 1px solid #fee2e2; border-radius: 6px; }

        /* HERO & CONTEÚDO */
        .hero { background: linear-gradient(to right, var(--senac-blue), var(--senac-dark-blue)); color: white; padding: 60px 0; text-align: center; }
        .hero h1 { font-size: 2.25rem; margin-bottom: 10px; }
        .welcome-section { display: flex; justify-content: center; padding: 60px 0; background-color: var(--senac-blue); margin: 0 -20px 0 -20px; }
        .welcome-card { background-color: var(--white); border-radius: 16px; padding: 40px; width: 100%; max-width: 1060px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); position: relative; }
        .welcome-card::after { content: ''; display: block; height: 10px; background-color: var(--senac-dark-blue); border-radius: 0 0 16px 16px; margin: 40px -40px -40px -40px; }
        .welcome-title { font-size: 2rem; font-weight: 900; color: var(--senac-dark-blue); border-bottom: 3px solid var(--senac-orange); padding-bottom: 10px; margin-bottom: 20px; }
        
        /* FLUXOGRAMA & ARTES */
        .timeline-container { position: relative; padding: 40px 0; }
        .timeline-line::before { content: ''; position: absolute; top: 0; bottom: 0; left: 50%; width: 4px; background: #e2e8f0; transform: translateX(-50%); z-index: 0; }
        .timeline-step { display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .step-content { width: 45%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1; cursor: pointer; transition: 0.2s; }
        .step-content:hover { transform: translateY(-5px); border-color: var(--senac-orange); }
        .step-content h3 { color: var(--senac-blue); font-size: 1.125rem; margin-bottom: 5px; font-weight: bold; }
        .step-number { width: 50px; height: 50px; border-radius: 50%; background: var(--senac-blue); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.125rem; border: 4px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; }
        .step-number.bg-orange { background: var(--senac-orange); } .step-number.bg-green { background: var(--senac-green); }
        .border-left-orange { border-left: 4px solid var(--senac-orange); } .border-right-blue { border-right: 4px solid var(--senac-blue); text-align: right; }
        .border-left-blue { border-left: 4px solid var(--senac-blue); } .border-right-orange { border-right: 4px solid var(--senac-orange); text-align: right; }
        .border-left-green { border-left: 4px solid var(--senac-green); } .border-right-green { border-right: 4px solid var(--senac-green); text-align: right; }
        .empty-space { width: 45%; }
        
        /* ARTES FLUTUANTES - AJUSTADAS */
        .timeline-art { 
            position: absolute; 
            z-index: 5; 
            width: 250px; 
            height: auto; 
            min-height: 200px;
            background: var(--senac-blue); 
            color: white; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-radius: 8px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            padding: 25px 20px; 
            transition: transform 0.3s;
            font-family: 'Roboto', 'Arial', sans-serif; 
            text-decoration: none !important;
            cursor: pointer; 
            border-left: 6px solid var(--senac-orange);
        }
        .timeline-art:hover { transform: scale(1.05) rotate(0deg) !important; z-index: 20; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .art-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .art-coat { position: absolute; bottom: -15px; right: -10px; width: 40px; opacity: 0.3; }
        .art-title { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; margin-bottom: 5px; line-height: 1.2; color: white; text-align: left; }
        .art-subtitle { font-weight: 700; color: var(--senac-orange); margin-bottom: 12px; font-size: 0.9rem; text-transform: uppercase; text-align: left; }
        .art-desc { font-size: 0.8rem; line-height: 1.4; color: #e2e8f0; font-weight: 300; text-align: left; margin-bottom: 10px; }

        .timeline-art.art-1 { top: 250px; left: -300px; transform: rotate(-7deg); }
        .timeline-art.art-2 { top: 750px; right: -300px; left: auto; transform: rotate(10deg); }
        .timeline-art.art-3 { top: 1300px; left: -300px; transform: rotate(-4deg); }
        .timeline-art.art-4 { top: 1850px; right: -300px; left: auto; transform: rotate(5deg); }

        /* MODAIS DO SITE */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box { background: white; padding: 40px 30px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; transform: translateY(20px); transition: 0.3s; position: relative; }
        .modal-overlay.active .modal-box { transform: translateY(0); }
        .modal-glass { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 16px; width: 90%; max-width: 600px; text-align: left; transform: scale(0.95); transition: 0.3s; position: relative; box-shadow: 0 8px 32px rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.4); }
        .modal-overlay.active .modal-glass { transform: scale(1); }
        .close-modal-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #999; cursor: pointer; }
        
        /* DOCS & EQUIPE */
        .grid-docs { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .doc-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; transition: 0.2s; }
        .doc-card:hover { border-color: #bfdbfe; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .doc-header { display: flex; gap: 15px; }
        .icon-box { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 1.25rem; }
        .ib-blue { background: #eff6ff; color: var(--senac-blue); } .ib-orange { background: #fff7ed; color: var(--senac-orange); }
        .member-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; display: flex; align-items: flex-start; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--senac-blue); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0; font-size: 1.2rem; }
        .avatar-gray { background: #6b7280; }
        
        /* FOOTER & MOBILE */
        footer { background-color: var(--senac-dark-blue); color: white; padding: 50px 0 20px; margin-top: auto; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-col h4 { font-size: 1.125rem; font-weight: bold; margin-bottom: 15px; }
        .mobile-menu-btn { display: none; font-size: 24px; color: #6b7280; }
        .mobile-menu-dropdown { display: none; background: #f9fafb; border-top: 1px solid #eee; }
        .mobile-link { display: block; padding: 12px 20px; color: var(--senac-blue); font-weight: 600; border-bottom: 1px solid #eee; width: 100%; text-align: left; }

        @media (max-width: 1400px) { .timeline-art { width: 220px; } .timeline-art.art-1 { left: -250px; } .timeline-art.art-2 { right: -250px; } }
        @media (max-width: 1000px) { .timeline-art { display: none; } }
        @media (max-width: 768px) {
            .nav-links, .blackboard-btn, .logo-text, .logout-btn, .navbar-actions { display: none; } .mobile-menu-btn { display: block; }
            .timeline-line::before { left: 30px; } .timeline-step { flex-direction: column; align-items: flex-start; } .step-content { width: 100%; margin-left: 60px; margin-top: -40px; } .empty-space { display: none; }
            .welcome-section { padding: 40px 10px; margin: 0; }
        }

        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin-top: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* =========================================
           ESTILOS DO PAINEL BI (DADOS) - INTEGRADO
           ========================================= */
        .text-senac-blue { color: var(--senac-blue); }
        .text-senac-orange { color: var(--senac-orange); }
        .bg-senac-blue { background-color: var(--senac-blue); }
        .bg-senac-orange { background-color: var(--senac-orange); }
        
        .card-bi { background: white; border-radius: 16px; box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; transition: transform 0.2s, box-shadow 0.2s; }
        .card-bi:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .scope-btn { transition: all 0.2s ease; border-bottom: 3px solid transparent; opacity: 0.6; cursor: pointer; }
        .scope-btn.active { opacity: 1; border-bottom-color: var(--senac-orange); background-color: #f8fafc; color: var(--senac-blue); }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #f68d2e; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Loader Gigante do BI */
        .loader-large { border: 5px solid #e2e8f0; border-radius: 50%; border-top: 5px solid var(--senac-blue); width: 60px; height: 60px; animation: spin 1s linear infinite; }

        .money-input { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-weight: 600; color: #0f172a; width: 100%; transition: all 0.2s; }
        .money-input:focus { border-color: var(--senac-blue); outline: none; background: white; box-shadow: 0 0 0 3px rgba(0, 69, 135, 0.1); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Z-Index Force dentro da aba */
        #biLoginPage { z-index: 50; }
        #biGlobalLoader { z-index: 60; }
        #biAppContainer { z-index: 10; }
        
        .phase-badge { text-align: center; margin: 30px 0; position: relative; z-index: 2; }
        .phase-badge span { display: inline-block; padding: 8px 20px; border-radius: 50px; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .phase-blue span { background: var(--senac-blue); }
        .phase-orange span { background: var(--senac-orange); }
        .phase-green span { background: var(--senac-green); }
    </style>
</head>
<body id="main-body" class="locked">

    <!-- LOGIN SCREEN PRINCIPAL (ACESSO AO SITE) -->
    <div id="login-screen">
        <div class="login-box">
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac Logo" style="height: 60px; margin: 0 auto 20px;">
            <h2 class="login-title">Acesso Restrito</h2>
            <p class="login-desc">Insira a senha padrão enviada no e-mail de convite para acessar o portal.</p>
            <form onsubmit="event.preventDefault(); checkPassword();">
                <div class="password-container">
                    <label class="password-label">Senha de Acesso</label>
                    <input type="password" id="password-input" class="password-input" placeholder="Digite a senha..." required>
                    <div id="error-msg" class="error-msg"><i class="fas fa-exclamation-circle"></i> Senha incorreta. Tente novamente.</div>
                </div>
                <button type="submit" class="btn-primary"><i class="fas fa-unlock-alt"></i> Acessar Portal</button>
            </form>
            <p style="font-size: 12px; color: #999; margin-top: 30px;">Senac PR &bull; Departamento Regional</p>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL DO SITE -->
    <div id="site-content" class="hidden-section flex flex-col min-h-screen">
        
        <nav class="navbar">
            <div class="container nav-content">
                <div class="logo-area">
                    <a href="#" onclick="switchTab('boas-vindas')" style="display: flex; align-items: center;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Logo">
                        <span class="logo-text">Portal do Supervisor</span>
                    </a>
                </div>
                <div class="nav-links">
                    <button onclick="switchTab('boas-vindas')" id="btn-boas-vindas" class="nav-btn active">Boas-Vindas</button>
                    <!-- ABA DADOS AGORA É O PAINEL BI -->
                    <button onclick="switchTab('dados')" id="btn-dados" class="nav-btn">Dados</button>
                    <button onclick="switchTab('fluxograma')" id="btn-fluxograma" class="nav-btn">Fluxograma</button>
                    <button onclick="switchTab('documentos')" id="btn-documentos" class="nav-btn">Documentos</button>
                    <button onclick="switchTab('equipe')" id="btn-equipe" class="nav-btn">Equipe</button>
                </div>
                <div class="navbar-actions">
                    <button onclick="logout()" class="logout-btn">Sair</button>
                    <a href="https://senac.blackboard.com/" target="_blank" class="blackboard-btn">Acessar BlackBoard</a>
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
            </div>
            
            <div class="mobile-menu-dropdown" id="mobile-menu">
                <button onclick="switchTab('boas-vindas')" class="mobile-link">Boas-Vindas</button>
                <button onclick="switchTab('dados')" class="mobile-link">Dados</button>
                <button onclick="switchTab('fluxograma')" class="mobile-link">Fluxograma</button>
                <button onclick="switchTab('documentos')" class="mobile-link">Documentos</button>
                <button onclick="switchTab('equipe')" class="mobile-link">Equipe</button>
                <button onclick="logout()" class="mobile-link" style="color: red;">Sair do Sistema</button>
            </div>
        </nav>

        <div class="hero">
            <div class="container">
                <h1 id="hero-title">Bem-Vindo(a) Supervisor(a)!</h1>
                <p id="hero-subtitle">Portal de apoio para a supervisão da Prática Profissional do Senac PR.</p>
            </div>
        </div>

        <!-- MAIN CONTAINER -->
        <main class="container" style="padding-top: 40px; padding-bottom: 40px; flex-grow: 1;">
            
            <!-- ABA: BOAS-VINDAS -->
            <div id="view-boas-vindas" class="welcome-section">
                <div class="welcome-card">
                    <h2 class="welcome-title">APRESENTAÇÃO</h2>
                    <div class="welcome-text">
                        <p>É com grande satisfação que damos as <strong>boas-vindas</strong> a você que faz parte da equipe de <strong>Supervisores da Prática Profissional do Senac Paraná</strong>.</p>
                        <p>A prática profissional é um momento crucial na formação de nossos estudantes. E para que esse período seja um sucesso, contamos com a sua colaboração e dedicação.</p>
                        <p>Seu <strong>acompanhamento e orientações</strong> são essenciais para <strong>melhorar o processo educacional</strong> e <strong>fortalecer a parceria entre o Senac e a empresa</strong>, por meio de monitoramento contínuo, diálogo, observações, orientações e ações preventivas.</p>
                        <p>Agradecemos por fazer parte da nossa equipe! Conte conosco para qualquer dúvida.</p>
                        <p class="text-center" style="margin-top: 30px;"><img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac Logo" style="height: 30px; margin: 0 auto;"></p>
                    </div>
                </div>
            </div>

            <!-- ABA: DADOS (PAINEL BI INTEGRADO) -->
            <div id="view-dados" class="hidden-section w-full h-[800px] relative rounded-xl overflow-hidden border border-slate-200 shadow-lg bg-slate-50 font-sans text-slate-800 flex flex-col">
                
                <!-- 1. TELA DE LOGIN BI -->
                <div id="biLoginPage" class="absolute inset-0 flex items-center justify-center bg-slate-100 z-[50]">
                    <div class="absolute inset-0 overflow-hidden pointer-events-none">
                        <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-blue-900/5 blur-3xl"></div>
                        <div class="absolute top-[60%] -right-[10%] w-[40%] h-[60%] rounded-full bg-orange-500/5 blur-3xl"></div>
                    </div>

                    <div id="biLoginCard" class="bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-md p-8 relative overflow-hidden mx-4">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-senac-blue to-senac-orange"></div>
                        
                        <div class="text-center mb-8">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac Logo" class="h-16 mx-auto mb-4" style="display: block;">
                            <h2 class="text-2xl font-extrabold text-senac-blue">Portal do Supervisor</h2>
                            <p class="text-sm text-slate-500 mt-1">Validação de Segurança</p>
                        </div>

                        <div id="biLoginForm">
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Região de Atuação</label>
                                    <div class="relative">
                                        <select id="biLoginRegion" onchange="toggleBiLoginMethod()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 appearance-none cursor-pointer">
                                            <option value="">Acesso Geral (Todas as Regiões)</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>

                                <div id="biEmailContainer" class="hidden animate-fade-in">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Seu E-mail Corporativo</label>
                                    <div class="relative">
                                        <input type="email" id="biLoginEmail" placeholder="nome.sobrenome@senac.br" 
                                            class="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50">
                                        <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>

                                <div id="biPasswordContainer" class="animate-fade-in">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Senha de Acesso</label>
                                    <div class="relative">
                                        <input type="password" id="biLoginPassword" placeholder="Digite a senha de gestão" 
                                            class="w-full p-3 pl-10 pr-10 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50">
                                        <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="performBiLogin()" class="w-full py-3 bg-senac-blue hover:bg-blue-800 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-900/10 flex items-center justify-center gap-2 cursor-pointer transform hover:scale-[1.02]">
                                <span>Acessar Painel</span>
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>

                             <div class="mt-6 flex justify-center items-center px-2">
                                <button onclick="resetBiUsersToDefault()" class="text-[10px] text-slate-400 hover:text-red-500 hover:underline">
                                    Restaurar Padrão
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. TELA DE CARREGAMENTO GLOBAL BI -->
                <div id="biGlobalLoader" class="absolute inset-0 flex flex-col items-center justify-center bg-white hidden z-[60]">
                    <div class="loader-large mb-6"></div>
                    <h3 class="text-xl font-bold text-slate-700 mb-2">Aguarde um momento</h3>
                    <p id="biLoadingMessage" class="text-sm text-slate-500 font-mono">Autenticando usuário...</p>
                </div>

                <!-- 3. ÁREA PRINCIPAL DO SISTEMA BI (Inicialmente Oculta) -->
                <div id="biAppContainer" class="hidden flex-col h-full w-full opacity-0 transition-opacity duration-700 z-[10]">
                    
                    <!-- Header -->
                    <header class="bg-white border-b border-slate-200 flex-shrink-0 z-30 shadow-sm flex flex-col">
                        <!-- Top Bar -->
                        <div class="h-16 flex items-center justify-between px-8">
                            <div class="flex items-center gap-4">
                                <div class="flex flex-col select-none justify-center">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac" class="h-10">
                                </div>
                                <div class="h-8 w-px bg-slate-200 mx-2"></div>
                                <div>
                                    <h1 class="font-bold text-sm text-slate-700">Painel de Supervisão</h1>
                                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Gestão de Aprendizagem</p>
                                </div>
                            </div>

                            <div class="flex items-center gap-6">
                                <!-- Info Usuário -->
                                <div class="text-right hidden md:block">
                                    <p class="text-sm font-bold text-senac-blue" id="biDisplayUserName"></p>
                                    <p class="text-[10px] text-slate-400 font-mono" id="biDisplayUserRegion"></p>
                                </div>

                                <!-- Botão Upload -->
                                <div class="flex items-center gap-2">
                                    <input type="file" id="biFileInput" accept=".csv, .xlsx, .xlsm, .xls" class="hidden" onchange="processBiFile(this)">
                                    <button onclick="document.getElementById('biFileInput').click()" class="group flex items-center gap-2 bg-slate-50 hover:bg-senac-blue hover:text-white text-slate-600 px-4 py-2 rounded-xl border border-slate-200 transition-all shadow-sm" title="Carregar Dados Gerais.xlsm">
                                        <i data-lucide="upload-cloud" class="w-4 h-4 text-senac-orange group-hover:text-white transition-colors"></i>
                                        <span id="biBtnUploadText" class="text-xs font-bold uppercase">Carregar Dados</span>
                                    </button>
                                </div>
                                
                                <button onclick="logoutBi()" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition-colors" title="Sair / Trocar Usuário">
                                    <i data-lucide="log-out" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Navegação (Tabs) -->
                        <div class="flex px-8 bg-white gap-8 border-t border-slate-50">
                            <button onclick="switchBiTab('qualificacao')" id="biTabQualificacao" class="scope-btn active py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                                <i data-lucide="book-open" class="w-4 h-4"></i>
                                Aprendizagem Qualificação
                            </button>
                            <button onclick="switchBiTab('tecnico')" id="biTabTecnico" class="scope-btn py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                                <i data-lucide="wrench" class="w-4 h-4"></i>
                                Aprendizagem Técnica
                            </button>
                            <button onclick="switchBiTab('financeiro')" id="biTabFinanceiro" class="scope-btn py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2 text-emerald-600">
                                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                Gestão Financeira
                            </button>
                        </div>
                    </header>

                    <!-- VIEWS -->
                    <div class="flex-1 overflow-hidden relative">
                        
                        <!-- VIEW 1: DASHBOARD OPERACIONAL -->
                        <div id="biViewDashboard" class="flex h-full w-full">
                            <!-- Sidebar Filtros -->
                            <aside class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 overflow-y-auto shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                                <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2 mb-5">
                                        <div class="p-1.5 bg-white border border-slate-200 rounded-lg shadow-sm text-senac-orange">
                                            <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                                        </div>
                                        Filtros Avançados
                                    </h3>
                                    
                                    <div class="relative group mb-5">
                                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-senac-blue transition-colors"></i>
                                        <input type="text" id="biFilterSearch" onkeyup="applyBiFilters()" placeholder="Buscar Jovem ou Turma..." 
                                            class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:border-senac-blue focus:ring-4 focus:ring-blue-50 outline-none transition-all shadow-sm">
                                    </div>

                                    <div class="mb-6">
                                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Situação do Contrato</label>
                                        <div class="relative">
                                            <select id="biFilterContractStatus" onchange="applyBiFilters()" class="w-full appearance-none p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 transition-all cursor-pointer text-slate-700 font-medium">
                                                <option value="active">Apenas Ativos (Padrão)</option>
                                                <option value="closed" class="text-red-600 font-bold">Apenas Encerrados</option>
                                                <option value="all">Todos (Ativos + Encerrados)</option>
                                            </select>
                                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                        </div>
                                    </div>

                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Região</label>
                                            <div class="relative">
                                                <select id="biFilterRegiao" onchange="handleBiRegionChange()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700 disabled:opacity-50 disabled:bg-slate-100">
                                                    <option value="">Todas as Regiões</option>
                                                </select>
                                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                            </div>
                                            <p id="biRegionLockMsg" class="hidden text-[10px] text-senac-orange mt-1 font-bold flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> Filtro bloqueado pelo perfil</p>
                                        </div>
                                        <div>
                                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Cidade</label>
                                            <div class="relative">
                                                <select id="biFilterCidade" onchange="applyBiFilters()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700">
                                                    <option value="">Todas as Cidades</option>
                                                </select>
                                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NOVA SEÇÃO: INTEGRAÇÃO GEMINI (INSERIDA DENTRO DA ESTRUTURA ORIGINAL) -->
                                    <div class="mt-8 pt-6 border-t border-slate-200">
                                        <h3 class="font-bold text-slate-700 flex items-center gap-2 mb-3">
                                            <div class="p-1.5 bg-gradient-to-tr from-blue-500 to-purple-500 rounded-lg shadow-sm text-white">
                                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                            </div>
                                            Assistente Gemini AI
                                        </h3>
                                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Google API Key</label>
                                            <input type="password" id="geminiApiKey" placeholder="Cole sua chave aqui..." class="w-full p-2 text-sm bg-white border border-slate-200 rounded-lg mb-2 focus:border-senac-blue outline-none">
                                            <button type="button" onclick="conectarGemini()" class="w-full py-2 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-900 transition-all flex items-center justify-center gap-2">
                                                Conectar IA <i data-lucide="zap" class="w-3 h-3"></i>
                                            </button>
                                            <p id="geminiStatus" class="text-[10px] text-slate-400 mt-2 text-center"></p>
                                        </div>
                                    </div>
                                    <!-- FIM DA SEÇÃO GEMINI -->

                                </div>

                                <div class="p-6 mt-auto bg-slate-50 border-t border-slate-200">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Legenda de Situação</p>
                                    <div class="space-y-2.5">
                                        <div class="flex items-center gap-2.5">
                                            <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]"></div>
                                            <span class="text-xs text-slate-600 font-medium">No Prazo / Realizada</span>
                                        </div>
                                        <div class="flex items-center gap-2.5">
                                            <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.4)]"></div>
                                            <span id="biLegendDelayedText" class="text-xs text-slate-600 font-medium">Atrasado (> 90 dias)</span>
                                        </div>
                                        <div class="flex items-center gap-2.5">
                                            <div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>
                                            <span class="text-xs text-slate-400">Encerrado</span>
                                        </div>
                                    </div>
                                </div>
                            </aside>

                            <!-- Conteúdo Principal Dashboard -->
                            <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
                                <!-- KPIs -->
                                <div class="p-6 pb-2 grid grid-cols-12 gap-6 h-auto flex-shrink-0">
                                    <div class="col-span-12 lg:col-span-3 grid grid-cols-1 gap-4">
                                        <div onclick="filterBiByStatus('all')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-senac-blue">
                                            <div class="flex justify-between items-start z-10 relative">
                                                <div>
                                                    <p class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Visualizado</p>
                                                    <h2 class="text-3xl font-extrabold text-slate-800 group-hover:text-senac-blue transition-colors" id="biKpiTotal">0</h2>
                                                </div>
                                                <div class="p-2.5 bg-blue-50 text-senac-blue rounded-xl group-hover:scale-110 transition-transform">
                                                    <i data-lucide="users" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <div onclick="filterBiByStatus('atrasado')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-red-500">
                                            <div class="flex justify-between items-start z-10 relative">
                                                <div>
                                                    <p class="text-[11px] text-red-400 font-bold uppercase tracking-wider mb-1">Visitas Atrasadas</p>
                                                    <h2 class="text-3xl font-extrabold text-red-600" id="biKpiAtrasados">0</h2>
                                                    <p id="biKpiDelayedText" class="text-[10px] text-red-400 mt-1 font-medium">Fora do prazo de 90 dias</p>
                                                </div>
                                                <div class="p-2.5 bg-red-50 text-red-500 rounded-xl group-hover:scale-110 transition-transform">
                                                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div onclick="filterBiByStatus('noprazo')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-emerald-500">
                                            <div class="flex justify-between items-start z-10 relative">
                                                <div>
                                                    <p class="text-[11px] text-emerald-500 font-bold uppercase tracking-wider mb-1">Em Dia</p>
                                                    <h2 class="text-3xl font-extrabold text-emerald-600" id="biKpiNoPrazo">0</h2>
                                                </div>
                                                <div class="p-2.5 bg-emerald-50 text-emerald-500 rounded-xl group-hover:scale-110 transition-transform">
                                                    <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Gráficos -->
                                    <div class="col-span-12 md:col-span-4 lg:col-span-4 card-bi p-5 flex flex-col">
                                        <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                                            <i data-lucide="pie-chart" class="w-4 h-4 text-senac-orange"></i> Status Geral
                                        </h3>
                                        <div class="flex-1 min-h-0 relative flex items-center justify-center">
                                            <canvas id="biChartStatus"></canvas>
                                        </div>
                                    </div>

                                    <div class="col-span-12 md:col-span-5 lg:col-span-5 card-bi p-5 flex flex-col">
                                        <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-senac-blue"></i> Top Cidades/Regiões
                                        </h3>
                                        <div class="flex-1 min-h-0 relative">
                                            <canvas id="biChartRegiao"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabela -->
                                <div class="flex-1 px-6 pb-6 overflow-hidden flex flex-col">
                                    <div class="card-bi flex-1 flex flex-col overflow-hidden bg-white">
                                        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                                            <div class="flex items-center gap-3">
                                                <div class="p-2 bg-slate-100 rounded-lg text-slate-600">
                                                    <i data-lucide="list" class="w-4 h-4"></i>
                                                </div>
                                                <div>
                                                    <h3 class="font-bold text-slate-700 text-sm">Detalhamento dos Contratos</h3>
                                                    <p class="text-xs text-slate-400 mt-0.5">Mostrando <strong id="biCountFiltered" class="text-senac-blue">0</strong> registros</p>
                                                </div>
                                            </div>
                                            
                                            <div class="flex gap-2">
                                                <button onclick="exportBiReport()" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold transition-all shadow-md shadow-emerald-200">
                                                    <i data-lucide="download" class="w-4 h-4"></i> Baixar Relatório
                                                </button>
                                            </div>
                                        </div>

                                        <div class="flex-1 overflow-auto custom-scrollbar">
                                            <table class="w-full text-left border-collapse">
                                                <thead class="bg-slate-50 sticky top-0 z-10 text-[11px] uppercase text-slate-500 font-bold tracking-wide shadow-sm">
                                                    <tr>
                                                        <th class="p-4 w-[25%]">Jovem / Turma</th>
                                                        <th class="p-4 w-[20%]">Empresa / Cidade</th>
                                                        <th class="p-4 w-[20%]">Supervisor</th>
                                                        <th class="p-4 w-[10%] text-center">Início/Fim</th>
                                                        <th class="p-4 w-[15%] text-center">Situação Visitas</th>
                                                        <th class="p-4 w-[10%] text-center">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="biTableBody" class="divide-y divide-slate-100 text-sm">
                                                    <tr>
                                                        <td colspan="6" class="p-12 text-center text-slate-400">
                                                            <div class="flex flex-col items-center gap-3">
                                                                <div class="w-16 h-16 bg-blue-50 text-senac-blue rounded-full flex items-center justify-center mb-2">
                                                                    <i data-lucide="folder-open" class="w-8 h-8"></i>
                                                                </div>
                                                                <p class="text-sm font-bold text-slate-600">Aguardando dados...</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <div class="p-3 border-t border-slate-100 flex justify-between items-center bg-slate-50 rounded-b-2xl px-6">
                                            <span class="text-xs text-slate-500">Página <span id="biPageDisplay" class="font-bold text-slate-700">1</span></span>
                                            <div class="flex gap-2">
                                                <button onclick="changeBiPage(-1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="biBtnPrev">Anterior</button>
                                                <button onclick="changeBiPage(1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="biBtnNext">Próxima</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </main>
                        </div>

                        <!-- VIEW 2: DASHBOARD FINANCEIRO -->
                        <div id="biViewFinanceiro" class="hidden h-full w-full bg-slate-50/50 flex-col overflow-auto p-8">
                            
                            <div class="max-w-7xl mx-auto w-full">
                                <div class="flex items-center justify-between mb-8">
                                    <div>
                                        <h2 class="text-2xl font-bold text-slate-800">Gestão Orçamentária de Visitas</h2>
                                        <p class="text-sm text-slate-500">Comparativo de orçamento disponível versus estimativa de custos para visitas pendentes.</p>
                                    </div>
                                    <div class="bg-white p-2 rounded-xl shadow-sm border border-slate-200 flex items-center gap-2">
                                        <span class="text-xs font-bold uppercase text-slate-400 px-2">Escopo Total:</span>
                                        <span class="text-sm font-bold text-senac-blue">Qualificação + Técnico</span>
                                    </div>
                                </div>

                                <!-- Painel de Inputs e KPIs -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                                    <!-- Input: Orçamento -->
                                    <div class="card-bi p-5 border-l-4 border-l-emerald-500">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Orçamento Disponível (R$)</label>
                                        <input type="number" id="biInputBudget" value="5000" class="money-input text-xl" oninput="updateBiFinancials()">
                                        <p class="text-[10px] text-slate-400 mt-2">Valor total em caixa para o período.</p>
                                    </div>

                                    <!-- Input: Custo Médio -->
                                    <div class="card-bi p-5 border-l-4 border-l-blue-500">
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Custo Estimado por Visita (R$)</label>
                                        <input type="number" id="biInputCost" value="85.50" class="money-input text-xl" oninput="updateBiFinancials()">
                                        <p class="text-[10px] text-slate-400 mt-2">Média (Km + Diária/Refeição).</p>
                                    </div>

                                    <!-- KPI: Visitas Pendentes -->
                                    <div class="card-bi p-5 flex flex-col justify-center">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Visitas Pendentes (Total)</p>
                                                <h3 class="text-3xl font-extrabold text-slate-700" id="biFinPendingVisits">0</h3>
                                            </div>
                                            <div class="p-3 bg-slate-100 rounded-full text-slate-500">
                                                <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- KPI: Custo Total Estimado -->
                                    <div class="card-bi p-5 flex flex-col justify-center bg-slate-800 text-white border-none">
                                        <div>
                                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Custo Total Projetado</p>
                                            <h3 class="text-3xl font-extrabold text-white" id="biFinProjectedCost">R$ 0,00</h3>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráfico e Saldo -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                    <div class="col-span-1 card-bi p-6 flex flex-col items-center justify-center text-center">
                                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Saldo Projetado</p>
                                        <h2 class="text-4xl font-extrabold mb-2" id="biFinBalance">R$ 0,00</h2>
                                        <div id="biFinStatusBadge" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-slate-100 text-slate-500">
                                            Aguardando Cálculo
                                        </div>
                                        <p class="text-xs text-slate-400 mt-4 max-w-[200px]">
                                            Se negativo, o orçamento não cobrirá todas as visitas pendentes.
                                        </p>
                                    </div>
                                    <div class="col-span-2 card-bi p-5">
                                        <h3 class="text-xs font-bold text-slate-600 uppercase mb-4">Comparativo Financeiro</h3>
                                        <div class="h-64 w-full relative">
                                            <canvas id="biChartFinance"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabela de Detalhamento por Região -->
                                <div class="card-bi overflow-hidden">
                                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                                        <h3 class="font-bold text-slate-700 text-sm">Estimativa de Gastos por Região</h3>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-sm">
                                            <thead class="bg-white text-xs uppercase text-slate-500 font-bold border-b border-slate-100">
                                                <tr>
                                                    <th class="p-4">Região / Cidade</th>
                                                    <th class="p-4 text-center">Visitas Pendentes</th>
                                                    <th class="p-4 text-right">Custo Estimado</th>
                                                    <th class="p-4 text-center">% do Orçamento</th>
                                                </tr>
                                            </thead>
                                            <tbody id="biFinTableBody" class="divide-y divide-slate-100"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA: FLUXOGRAMA (Banner Ajustado) -->
            <div id="view-fluxograma" class="timeline-container timeline-line hidden-section">
                <!-- Banner 1: Decreto -->
                <a href="https://www.planalto.gov.br/ccivil_03/_Ato2023-2026/2023/Decreto/D11479.htm" target="_blank" class="timeline-art art-1">
                    <div class="art-content">
                        <div class="art-title">DECRETO Nº 11.479,</div>
                        <div class="art-subtitle">DE 6 DE ABRIL DE 2023</div>
                        <div class="art-desc">Altera o Decreto nº 9.579, de 22 de novembro de 2018, para dispor sobre o direito à profissionalização de adolescentes e jovens por meio de programas de aprendizagem profissional.</div>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Coat_of_arms_of_Brazil.svg" class="art-coat" alt="Brasão">
                </a>
                
                <div class="phase-badge"><span class="phase-blue"><span>Fase 1: Acesso & Planejamento</span></span></div>

                <!-- ETAPA 1 -->
                <div class="timeline-step" style="display: flex; flex-direction: column; align-items: center; margin-bottom: 50px;">
                    <div class="step-number" style="margin-bottom: 20px;">1</div>
                    <div class="step-content border-left-orange" style="width: 55%; float: none;" onclick="openStepInfo(1)">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-map-marker-alt" style="color: var(--senac-orange);"></i> Selecione a sua região
                        </h3>
                        <p style="margin-bottom: 15px;">Escolha a unidade abaixo para acessar sua planilha de planejamento no SharePoint.</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;" onclick="event.stopPropagation()">
                            <select id="fluxo-region-select" class="region-select" style="margin-bottom: 0; flex-grow: 1;">
                                <option value="" disabled selected>-- Selecione --</option>
                                <option value="campo_mourao">Campo Mourão</option>
                                <option value="francisco_beltrao">Francisco Beltrão</option>
                                <option value="guarapuava">Guarapuava</option>
                                <option value="umuarama">Umuarama</option>
                            </select>
                            <button onclick="accessRegionSpreadsheet()" class="btn-primary" style="width: auto; padding: 10px 20px; font-size: 0.9rem;">
                                Acessar <i class="fas fa-external-link-alt" style="margin-left: 5px;"></i>
                            </button>
                        </div>
                        <p id="region-access-msg" style="font-size: 0.75rem; color: #666; margin-top: 8px; font-style: italic; display: none;"></p>
                    </div>
                </div>

                <!-- ETAPA 2 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number bg-orange">2</div>
                    <div class="step-content border-right-blue" onclick="openStepInfo(2)">
                        <h3><i class="fas fa-desktop"></i> Execução no Desktop</h3>
                        <p>Ao acessar a planilha da sua região, selecione a opção para executá-la no desktop. Dessa forma, as macros serão ativadas e as abas de planejamento funcionarão de maneira automatizada.</p>
                    </div>
                </div>

                <!-- ETAPA 3 -->
                <div class="timeline-step">
                    <div class="step-content border-left-orange" onclick="openStepInfo(3)">
                        <h3><i class="fas fa-cloud-download-alt"></i> Download de Documentos</h3>
                        <p style="margin-bottom: 10px;">Selecione o documento necessário e clique em baixar.</p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;" onclick="event.stopPropagation()">
                            <select id="fluxo-doc-select" class="region-select" style="margin-bottom: 0; flex-grow: 1; font-size: 0.85rem; padding: 8px;">
                                <option value="" disabled selected>-- Escolha um arquivo --</option>
                                <option value="manual_simplificado.pdf">Manual simplificado</option>
                                <option value="guia_preenchimento.pdf">Guia de Preenchimento</option>
                                <option value="instrucao_completa.pdf">Instrução Completa</option>
                                <option value="lista_tip.pdf">Lista TIP (Horizontal)</option>
                                <option value="os_veiculo.pdf">OS - Veículo Próprio</option>
                                <option value="formulario_supervisao.docx">Formulário Supervisão 2025</option>
                                <option value="ata_programa.docx">ATA - Programa Aprendizagem</option>
                                <option value="capa_controle.pdf">Capa de Controle</option>
                            </select>
                            <button onclick="downloadSelectedDoc()" class="btn-primary" style="width: auto; padding: 8px 15px; font-size: 0.85rem; background-color: var(--senac-blue);">
                                Baixar
                            </button>
                        </div>
                    </div>
                    <div class="step-number">3</div>
                    <div class="empty-space"></div>
                </div>

                <!-- ETAPA 4 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number bg-orange">4</div>
                    <div class="step-content border-right-blue" onclick="openStepInfo(4)"><h3>Planilha de Planejamento</h3><p>Acesse “Planilha de planejamento – região”.</p></div>
                </div>
                
                <!-- ETAPA 5 -->
                <div class="timeline-step">
                    <div class="step-content border-left-orange" onclick="openStepInfo(5)"><h3>Configuração da Planilha</h3><p>Leia a aba “Avisos” e renomeie as abas.</p></div>
                    <div class="step-number">5</div><div class="empty-space"></div>
                </div>

                <div class="phase-badge"><span class="phase-orange"><span>Fase 2: Logística</span></span></div>
                
                <!-- Banner 2: Lei -->
                <a href="https://www.planalto.gov.br/ccivil_03/LEIS/L10097.htm" target="_blank" class="timeline-art art-2">
                    <div class="art-content">
                        <div class="art-title">Lei nº 10.097</div>
                        <div class="art-subtitle">de 19 de dezembro de 2000</div>
                        <div class="art-desc">Altera dispositivos da Consolidação das Leis do Trabalho – CLT, aprovada pelo Decreto-Lei nº 5.452, de 1º de maio de 1943.</div>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Coat_of_arms_of_Brazil.svg" class="art-coat" alt="Brasão">
                </a>
                
                <!-- ETAPA 6 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number bg-orange">6</div>
                    <div class="step-content border-right-blue" onclick="openStepInfo(6)"><h3>Montar Logística</h3><p>Montar logística na aba de planejamento.</p></div>
                </div>
                <!-- ETAPA 7 -->
                <div class="timeline-step">
                    <div class="step-content border-left-orange" onclick="openStepInfo(7)"><h3>Aprovação</h3><p>Avisar ao Polo-PR e aguardar.</p></div>
                    <div class="step-number">7</div><div class="empty-space"></div>
                </div>
                <!-- ETAPA 8 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number bg-orange">8</div>
                    <div class="step-content border-right-blue" onclick="openStepInfo(8)"><h3>Abertura de Viagem</h3><p>Pedido para abertura de viagem.</p></div>
                </div>
                <!-- ETAPA 9 -->
                <div class="timeline-step">
                    <div class="step-content border-left-orange" onclick="openStepInfo(9)"><h3>Confirmação</h3><p>Enviar e-mails aos supervisores.</p></div>
                    <div class="step-number">9</div><div class="empty-space"></div>
                </div>

                <div class="phase-badge"><span class="phase-green"><span>Fase 3: Execução</span></span></div>

                <!-- ETAPA 10 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number">10</div>
                    <div class="step-content border-right-blue" onclick="openStepInfo(10)">
                        <h3>Baixar Formulário e/ou ATA</h3>
                        <p>Acesse a aba <strong>"Documentos"</strong> ou baixe clicando aqui:</p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;" onclick="event.stopPropagation()">
                            <select id="step10-doc-select" class="region-select" style="margin-bottom: 0; flex-grow: 1; font-size: 0.85rem; padding: 8px;">
                                <option value="" disabled selected>-- Selecione --</option>
                                <option value="formulario_supervisao.docx">Formulário Supervisão 2025</option>
                                <option value="ata_programa.docx">ATA - Programa Aprendizagem</option>
                            </select>
                            <button onclick="downloadStep10Doc()" class="btn-primary" style="width: auto; padding: 8px 15px; font-size: 0.85rem; background-color: var(--senac-blue);">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ETAPA 11 -->
                <div class="timeline-step">
                    <div class="step-content border-left-orange" onclick="openStepInfo(11)"><h3>Preenchimento</h3><p>Preencher cabeçalho do formulário.</p></div>
                    <div class="step-number bg-orange">11</div><div class="empty-space"></div>
                </div>
                
                <!-- Banner 3: Portaria -->
                <a href="https://www.gov.br/trabalho-e-emprego/pt-br/assuntos/aprendizagem-profissional" target="_blank" class="timeline-art art-3">
                    <div class="art-content">
                        <div class="art-title" style="font-size: 1.2rem;">PORTARIA MTE Nº 3.872,</div>
                        <div class="art-subtitle" style="font-size: 0.9rem;">DE 21 DE DEZEMBRO DE 2023</div>
                        <div class="art-desc">Dispõe sobre a aprendizagem profissional, o Cadastro Nacional de Aprendizagem Profissional e o Catálogo Nacional da Aprendizagem Profissional.</div>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Coat_of_arms_of_Brazil.svg" class="art-coat" alt="Brasão">
                </a>

                 <!-- Banner 4: Lista TIP -->
                 <a href="https://www.planalto.gov.br/ccivil_03/_ato2007-2010/2008/decreto/d6481.htm" target="_blank" class="timeline-art art-4">
                    <div class="art-content">
                        <div class="art-title" style="font-size: 1.2rem;">LISTA TIP</div>
                        <div class="art-subtitle" style="font-size: 0.9rem;">PIORES FORMAS DE TRABALHO INFANTIL</div>
                        <div class="art-desc">Decreto nº 3.597, de 12 de setembro de 2000.</div>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Coat_of_arms_of_Brazil.svg" class="art-coat" alt="Brasão">
                </a>
                
                <!-- ETAPA 12 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number">12</div>
                    <div class="step-content border-right-blue" onclick="openStepInfo(12)">
                        <h3>Relatório de Desempenho</h3>
                        <p style="margin-bottom: 10px;">Selecione a região para consultar o relatório:</p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;" onclick="event.stopPropagation()">
                             <select id="relatorio-region-select" class="region-select" style="margin-bottom: 0; flex-grow: 1; font-size: 0.85rem; padding: 8px;">
                                <option value="" disabled selected>-- Selecione --</option>
                                <option value="campo_mourao">Campo Mourão</option>
                                <option value="francisco_beltrao">Francisco Beltrão</option>
                                <option value="guarapuava">Guarapuava</option>
                                <option value="umuarama">Umuarama</option>
                            </select>
                            <button onclick="accessPerformanceReport()" class="btn-primary" style="width: auto; padding: 8px 15px; font-size: 0.85rem; background-color: var(--senac-blue);">
                                Acessar
                            </button>
                        </div>
                         <p id="relatorio-access-msg" style="font-size: 0.75rem; color: #666; margin-top: 8px; font-style: italic; display: none; text-align: right;"></p>
                    </div>
                </div>

                <!-- ETAPA 13 -->
                <div class="timeline-step">
                    <div class="step-content border-left-orange" onclick="openStepInfo(13)"><h3>A Entrevista</h3><p>Entrevista com supervisor e estudante.</p></div>
                    <div class="step-number bg-orange">13</div><div class="empty-space"></div>
                </div>

                <div class="phase-badge"><span class="phase-green"><span>Fase 4: Finalização</span></span></div>
                
                <!-- ETAPA 14 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number">14</div>
                    <div class="step-content border-right-green" onclick="openStepInfo(14)">
                        <h3>Digitalizar + Enviar</h3>
                        <p>Digitalizar (Turma + Nome). Enviar no AVA.</p>
                        <button onclick="openUploadModal(); event.stopPropagation();" class="link-btn" style="color: var(--senac-green); background-color: #dcfce7; margin-top: 10px; width: 100%; justify-content: center;">
                            <i class="fas fa-upload" style="margin-right: 5px;"></i> Enviar Arquivos
                        </button>
                    </div>
                </div>
                
                <!-- ETAPA 15 -->
                <div class="timeline-step">
                    <div class="step-content border-left-green" onclick="openStepInfo(15)"><h3>Registro na Planilha</h3><p>Preencher dados pós-visita na planilha.</p></div>
                    <div class="step-number bg-orange">15</div><div class="empty-space"></div>
                </div>

                <!-- ETAPA 16 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number bg-green">16</div>
                    <div class="step-content border-right-green" onclick="openStepInfo(16)">
                        <h3>Informações para Rateio</h3>
                        <p>Atualizar informações de visitas.</p>
                    </div>
                </div>

                <!-- ETAPA 17 -->
                <div class="timeline-step">
                    <div class="step-content border-left-green" onclick="openStepInfo(17)">
                        <h3>Envio Malote</h3>
                        <p>Envio dos documentos via Malote</p>
                    </div>
                    <div class="step-number bg-orange">17</div>
                    <div class="empty-space"></div>
                </div>

                <!-- ETAPA 18 -->
                <div class="timeline-step">
                    <div class="empty-space"></div>
                    <div class="step-number bg-green">18</div>
                    <div class="step-content border-right-orange" style="background-color: #eff6ff;" onclick="openStepInfo(18)">
                        <h3>Conclusão</h3>
                        <p>Sinalizar ao Polo-PR.</p>
                        <p style="color: var(--senac-green); font-weight: bold; font-size: 0.75rem; text-transform: uppercase; margin-top: 5px;">Processo Finalizado</p>
                    </div>
                </div>
            </div>

            <!-- ABA: DOCUMENTOS -->
            <div id="view-documentos" class="hidden-section">
                <div class="search-bar-container">
                    <h2 style="color: var(--senac-blue); font-size: 1.5rem; font-weight: bold;">Central de Documentos</h2>
                    <div class="search-input-wrapper">
                        <input type="text" id="doc-search" onkeyup="filterDocuments()" class="search-input" placeholder="Buscar arquivo...">
                    </div>
                </div>
                
                <div class="doc-section-title" style="margin-bottom: 20px; font-weight: bold; color: var(--senac-blue);"><i class="fas fa-book-reader" style="color: var(--senac-blue); margin-right: 10px;"></i> Guias e Manuais</div>
                <div class="grid-docs">
                    <div class="doc-card">
                        <div class="doc-header">
                            <div class="icon-box ib-blue"><i class="fas fa-book"></i></div>
                            <div class="doc-info">
                                <h4>Manual simplificado</h4><p>Diretrizes gerais.</p>
                                <a href="manual_simplificado.pdf" target="_blank" class="download-link">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="doc-card">
                        <div class="doc-header">
                            <div class="icon-box ib-blue"><i class="fas fa-list-check"></i></div>
                            <div class="doc-info">
                                <h4>Guia de Preenchimento</h4><p>Passo a passo rápido.</p>
                                <a href="guia_preenchimento.pdf" target="_blank" class="download-link">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="doc-card">
                        <div class="doc-header">
                            <div class="icon-box ib-blue"><i class="fas fa-info-circle"></i></div>
                            <div class="doc-info">
                                <h4>Instrução Completa</h4><p>Detalhes técnicos.</p>
                                <a href="instrucao_completa.pdf" target="_blank" class="download-link">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="doc-card">
                        <div class="doc-header">
                            <div class="icon-box ib-blue"><i class="fas fa-clipboard-list"></i></div>
                            <div class="doc-info">
                                <h4>Lista TIP (Horizontal)</h4><p>Referência atualizada.</p>
                                <a href="lista_tip.pdf" target="_blank" class="download-link">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                      <div class="doc-card">
                        <div class="doc-header">
                            <div class="icon-box ib-blue"><i class="fas fa-car"></i></div>
                            <div class="doc-info">
                                <h4>OS - Veículo Próprio</h4><p>Ordem de serviço.</p>
                                <a href="os_veiculo.pdf" target="_blank" class="download-link">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="doc-section-title" style="margin-bottom: 20px; font-weight: bold; color: var(--senac-orange);"><i class="fas fa-file-signature" style="color: var(--senac-orange); margin-right: 10px;"></i> Formulários e Registros</div>
                <div class="grid-docs">
                    <div class="doc-card" style="border-left: 4px solid var(--senac-orange);">
                        <div class="doc-header">
                            <div class="icon-box ib-orange"><i class="fas fa-file-word"></i></div>
                            <div class="doc-info">
                                <h4>Formulário Supervisão 2025</h4><p>Obrigatório.</p>
                                <a href="formulario_supervisao.docx" target="_blank" class="download-link text-orange-hover">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="doc-card" style="border-left: 4px solid var(--senac-orange);">
                        <div class="doc-header">
                            <div class="icon-box ib-orange"><i class="fas fa-file-word"></i></div>
                            <div class="doc-info">
                                <h4>ATA - Programa Aprendizagem</h4><p>Inclui manual.</p>
                                <a href="ata_programa.docx" target="_blank" class="download-link text-orange-hover">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>

                    <div class="doc-card" style="border-left: 4px solid var(--senac-orange);">
                        <div class="doc-header">
                            <div class="icon-box ib-orange"><i class="fas fa-folder"></i></div>
                            <div class="doc-info">
                                <h4>Capa de Controle</h4><p>Organização física.</p>
                                <a href="capa_controle.pdf" target="_blank" class="download-link text-orange-hover">Baixar Arquivo <i class="fas fa-download" style="margin-left: 5px;"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA: EQUIPE -->
            <div id="view-equipe" class="hidden-section">
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 30px; margin-bottom: 40px;">
                    <h2 style="color: var(--senac-blue); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 25px;">Equipe Pedagógica</h2>
                    <div class="grid-docs">
                        <div class="member-card">
                            <div class="avatar">AP</div>
                            <div class="member-info">
                                <h3>Ana Paula</h3><div class="member-role">Analista Pleno</div>
                                <div class="member-contact">
                                    <a href="mailto:anapaula.duarte@pr.senac.br"><i class="fas fa-envelope"></i> anapaula.duarte@pr.senac.br</a>
                                    <a href="https://wa.me/554133145814" target="_blank"><i class="fab fa-whatsapp" style="color: #25D366;"></i> (41) 3314-5814</a>
                                </div>
                            </div>
                        </div>
                        <div class="member-card">
                            <div class="avatar">B</div>
                            <div class="member-info">
                                <h3>Bianca Aresta</h3><div class="member-role">Analista Pedagógica</div>
                                <div class="member-contact">
                                    <a href="mailto:bianca.aresta@pr.senac.br"><i class="fas fa-envelope"></i> bianca.aresta@pr.senac.br</a>
                                    <a href="https://wa.me/554133145875" target="_blank"><i class="fab fa-whatsapp" style="color: #25D366;"></i> (41) 3314-5875</a>
                                </div>
                            </div>
                        </div>
                        <div class="member-card">
                            <div class="avatar">B</div>
                            <div class="member-info">
                                <h3>Bruna Cunha</h3><div class="member-role">Analista Pedagógica</div>
                                <div class="member-contact">
                                    <a href="mailto:bruna.cunha@pr.senac.br"><i class="fas fa-envelope"></i> bruna.cunha@pr.senac.br</a>
                                    <a href="https://wa.me/554133145816" target="_blank"><i class="fab fa-whatsapp" style="color: #25D366;"></i> (41) 3314-5816</a>
                                </div>
                            </div>
                        </div>
                        <div class="member-card">
                            <div class="avatar">M</div>
                            <div class="member-info">
                                <h3>Mariana Mello</h3><div class="member-role">Analista Pedagógica</div>
                                <div class="member-contact">
                                    <a href="mailto:mariana.mello@pr.senac.br"><i class="fas fa-envelope"></i> mariana.mello@pr.senac.br</a>
                                    <a href="https://wa.me/554133145858" target="_blank"><i class="fab fa-whatsapp" style="color: #25D366;"></i> (41) 3314-5858</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 30px;">
                    <h2 style="color: var(--senac-blue); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 25px;">Equipe Administrativa Pedagógica</h2>
                    <div class="grid-docs">
                        <div class="member-card">
                            <div class="avatar avatar-gray">C</div>
                            <div class="member-info">
                                <h3>Cristina Maciel</h3><div class="member-role" style="color: #6b7280;">Assistente Administrativo</div>
                                <div class="member-contact">
                                    <a href="mailto:cristina.maciel@pr.senac.br"><i class="fas fa-envelope"></i> cristina.maciel@pr.senac.br</a>
                                    <a href="https://wa.me/554133145840" target="_blank"><i class="fab fa-whatsapp" style="color: #25D366;"></i> (41) 3314-5840</a>
                                </div>
                            </div>
                        </div>
                        <div class="member-card">
                            <div class="avatar avatar-gray">L</div>
                            <div class="member-info">
                                <h3>Leo Santos</h3><div class="member-role" style="color: #6b7280;">Assistente Administrativo</div>
                                <div class="member-contact">
                                    <a href="mailto:leo.santos@pr.senac.br"><i class="fas fa-envelope"></i> leo.santos@pr.senac.br</a>
                                    <a href="https://wa.me/554133145818" target="_blank"><i class="fab fa-whatsapp" style="color: #25D366;"></i> (41) 3314-5818</a>
                                </div>
                            </div>
                        </div>
                        <div class="member-card">
                            <div class="avatar avatar-gray">N</div>
                            <div class="member-info">
                                <h3>Nathalia</h3><div class="member-role" style="color: #6b7280;">Auxiliar Administrativa</div>
                                <div class="member-contact">
                                    <a href="mailto:nathalia@pr.senac.br"><i class="fas fa-envelope"></i> nathalia@pr.senac.br</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div class="container footer-grid">
                <div class="footer-col">
                    <h4>Senac PR</h4><p>Serviço Nacional de Aprendizagem Comercial</p><p>Portal interno do Supervisor da Prática Profissional.</p>
                </div>
                <div class="footer-col">
                    <h4>Links Rápidos</h4>
                    <ul>
                        <li><a href="mailto:cristina.maciel@pr.senac.br">Canal do Supervisor <i class="fas fa-envelope"></i></a></li>
                        <li><a href="https://wa.me/554133145817" target="_blank">Suporte ao Supervisor <i class="fab fa-whatsapp"></i></a></li>
                        <li><a href="https://intranet.pr.senac.br/ar/acm/index.asp?" target="_blank">Portal do Colaborador</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Contato</h4><p><a href="mailto:michel.farias@pr.senac.br"><i class="fas fa-envelope"></i> michel.farias@pr.senac.br</a></p><p><a href="https://wa.me/554133145817" target="_blank"><i class="fab fa-whatsapp"></i> (41) 3314-5817</a></p>
                </div>
            </div>
            <div class="container footer-bottom">&copy; 2025 Senac PR. Todos os direitos reservados.</div>
        </footer>
    </div>

    <!-- JANELA/MODAL DE UPLOAD (SITE ORIGINAL) -->
    <div id="upload-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal-btn" onclick="closeUploadModal()">&times;</button>
            <h2 style="color: var(--senac-blue); margin-bottom: 20px; font-weight: 900;">Enviar Arquivos</h2>
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; margin-top: 2px;"></i>
                <p>Lembre-se de renomear o arquivo com o <strong>número da turma + nome completo do jovem</strong>, para facilitar a identificação e arquivamento do documento.</p>
            </div>
            <label for="region-select" style="display: block; text-align: left; font-weight: bold; color: var(--senac-blue); margin-bottom: 5px;">Selecione sua Região:</label>
            <select id="region-select" class="region-select">
                <option value="">-- Escolha uma cidade --</option>
                <option value="campo_mourao">Campo Mourão</option>
                <option value="francisco_beltrao">Francisco Beltrão</option>
                <option value="guarapuava">Guarapuava</option>
                <option value="umuarama">Umuarama</option>
            </select>
            <div class="upload-area">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 10px;"></i>
                <p style="margin-bottom: 5px; color: #374151; font-weight: bold;">Upload Seguro</p>
                <p style="margin-bottom: 15px; font-size: 0.9rem; color: #6b7280;">Ao clicar no botão abaixo, você será redirecionado para a pasta segura da sua região.</p>
            </div>
            <button class="btn-primary" onclick="openUploadForm()" style="margin-top: 10px;"><i class="fas fa-external-link-alt"></i> Acessar Pasta de Envio</button>
        </div>
    </div>

    <!-- JANELA/MODAL PARA DETALHES DA ETAPA (SITE ORIGINAL) -->
    <div id="step-detail-modal" class="modal-overlay">
        <div class="modal-glass">
            <button class="close-modal-btn" onclick="closeStepInfo()">&times;</button>
            <div class="glass-header">
                <h2 id="step-modal-title" class="glass-title">Título da Etapa</h2>
                <div id="step-modal-subtitle" class="glass-subtitle">Fase do Processo</div>
            </div>
            <div id="step-modal-content" class="glass-content"></div>
        </div>
    </div>

    <!-- MÓDULO GEMINI (ADICIONADO) -->
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>

    <script>
        const loginScreen = document.getElementById('login-screen');
        const siteContent = document.getElementById('site-content');
        const body = document.getElementById('main-body');
        const passwordInput = document.getElementById('password-input');
        const errorMsg = document.getElementById('error-msg');
        const SENHA_CORRETA = "senac2026";

        function checkPassword() {
            if (passwordInput.value.toUpperCase() === SENHA_CORRETA.toUpperCase()) {
                localStorage.setItem('senac_auth', 'true');
                showContent();
            } else {
                errorMsg.style.display = 'flex';
                passwordInput.classList.add('error');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        passwordInput.addEventListener('input', () => { errorMsg.style.display = 'none'; passwordInput.classList.remove('error'); });

        function showContent() {
            loginScreen.style.display = 'none';
            siteContent.classList.remove('hidden-section');
            body.classList.remove('locked');
            switchTab('boas-vindas');
            // Inicializa usuários do BI
            initBiUsers(); 
        }

        function logout() { localStorage.removeItem('senac_auth'); location.reload(); }

        document.addEventListener("DOMContentLoaded", function() {
            if (localStorage.getItem('senac_auth') === 'true') { showContent(); }
            else { passwordInput.focus(); }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        function switchTab(tabName) {
            ['boas-vindas', 'fluxograma', 'dados', 'documentos', 'equipe'].forEach(tab => {
                document.getElementById('view-' + tab).classList.add('hidden-section');
                document.getElementById('btn-' + tab).classList.remove('active');
            });
            document.getElementById('view-' + tabName).classList.remove('hidden-section');
            document.getElementById('btn-' + tabName).classList.add('active');
            
            const titles = {
                'boas-vindas': ["Bem-Vindo(a) Supervisor(a)!", "Portal de apoio para a supervisão da Prática Profissional do Senac PR."],
                'fluxograma': ["Fluxo de Monitoramento", "Guia oficial para supervisão de práticas profissionais - Senac PR"],
                'dados': ["Painel de Dados", "Monitoramento em tempo real dos indicadores de aprendizagem."],
                'documentos': ["Central de Documentos", "Baixe todos os arquivos necessários."],
                'equipe': ["Equipe Técnica", "Contatos e responsáveis pedagógicos."]
            };
            document.getElementById('hero-title').innerText = titles[tabName][0];
            document.getElementById('hero-subtitle').innerText = titles[tabName][1];
            document.getElementById('mobile-menu').style.display = 'none';

            if(tabName === 'dados') {
                if(biCurrentUser && biDb.qualificacao.length > 0) {
                      setTimeout(() => { switchBiTab(biCurrentScope); }, 100);
                }
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }

        function filterDocuments() {
            let filter = document.getElementById('doc-search').value.toUpperCase();
            let cards = document.getElementsByClassName('doc-card');
            for (let i = 0; i < cards.length; i++) {
                let h4 = cards[i].getElementsByTagName("h4")[0];
                if (h4) { cards[i].style.display = (h4.textContent.toUpperCase().indexOf(filter) > -1) ? "" : "none"; }
            }
        }

        function openUploadModal() { document.getElementById('upload-modal').classList.add('active'); }
        function closeUploadModal() { document.getElementById('upload-modal').classList.remove('active'); }
        
        function openUploadForm() {
            const linksPorRegiao = {
                'campo_mourao': 'https://senacpr-my.sharepoint.com/:f:/g/personal/tutoria_aprendizagem_pr_senac_br/IgCtlUZaS1ViSqqd-LfwfAhUASl6_V1-GxHrAnWGuUj2BXo',
                'francisco_beltrao': 'https://senacpr-my.sharepoint.com/:f:/g/personal/tutoria_aprendizagem_pr_senac_br/IgA7auw4MZNYSbw2kUanBtuHAav-cBusC4wCelholjwhFKA',
                'guarapuava': 'https://senacpr-my.sharepoint.com/:f:/g/personal/tutoria_aprendizagem_pr_senac_br/IgB1-VVBjcpATae_CCqK4Bu9AdXZ09snZQ9uL2ZQKhnK_kw',
                'umuarama': 'https://senacpr-my.sharepoint.com/:f:/g/personal/tutoria_aprendizagem_pr_senac_br/IgCbQHxgU9rESphEFu8dbcXLAUB3tXkeaiwl972MD1LNgac'
            };
            const regiao = document.getElementById('region-select').value;
            if (regiao && linksPorRegiao[regiao]) { window.open(linksPorRegiao[regiao], '_blank'); closeUploadModal(); }
            else { alert("Selecione uma região válida."); }
        }

        function accessRegionSpreadsheet() {
            const regionSelect = document.getElementById('fluxo-region-select');
            const region = regionSelect.value;
            const msg = document.getElementById('region-access-msg');
            const spreadsheets = {
                'campo_mourao': { url: 'https://senacpr-my.sharepoint.com/personal/michel_farias_pr_senac_br/_layouts/15/Doc.aspx?sourcedoc={4d4d9d28-18e8-43ad-8031-72c6b13be916}&action=embedview&wdAllowInteractivity=False&wdInConfigurator=True&wdInConfigurator=True&edaebf=rslc0', contact: 'Luciano Ramos (luciano.ramos@docente.pr.senac.br)' },
                'francisco_beltrao': { url: 'https://senacpr-my.sharepoint.com/personal/michel_farias_pr_senac_br/_layouts/15/Doc.aspx?sourcedoc={25529649-c755-45b7-a875-a23707ffd7bb}&action=embedview&wdInConfigurator=True&wdInConfigurator=True&edaebf=rslc0', contact: 'Samoel Pitz (samoel.pitz@docente.pr.senac.br)' },
                'guarapuava': { url: 'https://senacpr-my.sharepoint.com/personal/michel_farias_pr_senac_br/_layouts/15/Doc.aspx?sourcedoc={5d1d386c-f1cf-41d2-8997-1ac56b37f657}&action=embedview&wdInConfigurator=True&wdInConfigurator=True&edaebf=rslc0', contact: 'Michelly Gronkoski (michelly.gronkoski@docente.pr.senac.br)' },
                'umuarama': { url: 'https://senacpr-my.sharepoint.com/', contact: 'Responsável Regional' }
            };
            if (region && spreadsheets[region]) {
                const data = spreadsheets[region];
                msg.style.display = 'block'; msg.innerHTML = `Gestor do acesso: ${data.contact}`;
                setTimeout(() => { window.open(data.url, '_blank'); }, 800);
            } else { alert("Por favor, selecione uma região válida."); }
        }

        function accessPerformanceReport() {
            const regionSelect = document.getElementById('relatorio-region-select');
            const region = regionSelect.value;
            const msg = document.getElementById('relatorio-access-msg');
            const reports = {
                'campo_mourao': { url: 'https://senacpr-my.sharepoint.com/personal/michel_farias_pr_senac_br/_layouts/15/Doc.aspx?sourcedoc={ca8dbe4f-36ab-44c3-98cd-ff5cc7844e41}&action=embedview&wdAllowInteractivity=False&wdHideGridlines=True&wdHideHeaders=True&wdDownloadButton=True&wdInConfigurator=True&wdInConfigurator=True&edaebf=rslc0', contact: 'Luciano Ramos (luciano.ramos@docente.pr.senac.br)' },
                'francisco_beltrao': { url: 'https://senacpr-my.sharepoint.com/personal/michel_farias_pr_senac_br/_layouts/15/Doc.aspx?sourcedoc={f3c19804-d04d-4dda-bdec-2f1ef0046129}&action=embedview&wdAllowInteractivity=False&wdHideGridlines=True&wdHideHeaders=True&wdDownloadButton=True&wdInConfigurator=True&wdInConfigurator=True&edaebf=rslc0', contact: 'Samoel Pitz (samoel.pitz@docente.pr.senac.br)' },
                'guarapuava': { url: 'https://senacpr-my.sharepoint.com/personal/michel_farias_pr_senac_br/_layouts/15/Doc.aspx?sourcedoc={7ce26397-6f96-4462-9771-d3c65a1914ac}&action=embedview&wdAllowInteractivity=False&wdHideGridlines=True&wdHideHeaders=True&wdDownloadButton=True&wdInConfigurator=True&wdInConfigurator=True&edaebf=rslc0', contact: 'Michelly Gronkoski (michelly.gronkoski@docente.pr.senac.br)' },
                'umuarama': { url: 'https://senacpr-my.sharepoint.com/', contact: 'Responsável Regional' }
            };
            if (region && reports[region]) {
                const data = reports[region];
                msg.style.display = 'block'; msg.innerHTML = `Gestor do acesso: ${data.contact}`;
                setTimeout(() => { window.open(data.url, '_blank'); }, 800);
            } else { alert("Por favor, selecione uma região para ver o relatório."); }
        }

        function downloadSelectedDoc() {
            const docSelect = document.getElementById('fluxo-doc-select');
            const selectedDoc = docSelect.value;
            if (selectedDoc) {
                const link = document.createElement('a'); link.href = selectedDoc; link.target = '_blank'; link.download = selectedDoc.split('/').pop(); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } else { alert("Por favor, selecione um documento para baixar."); }
        }

        function downloadStep10Doc() {
            const docSelect = document.getElementById('step10-doc-select');
            const selectedDoc = docSelect.value;
            if (selectedDoc) {
                const link = document.createElement('a'); link.href = selectedDoc; link.target = '_blank'; link.download = selectedDoc.split('/').pop(); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } else { alert("Por favor, selecione um arquivo (Formulário ou ATA)."); }
        }
        
        document.getElementById('upload-modal').addEventListener('click', function(e) { if (e.target === this) closeUploadModal(); });

        const stepData = {
            1: { title: "Seleção da Região", subtitle: "Fase 1: Acesso Inicial", text: "Nesta etapa, o supervisor deve identificar sua unidade de atuação (Campo Mourão, Francisco Beltrão, etc.). Ao selecionar e acessar, você será redirecionado para a planilha de gestão específica daquela região no SharePoint." },
            2: { title: "Execução no Desktop", subtitle: "Fase 1: Configuração Técnica", text: `<p style="margin-bottom: 10px;"><strong>Como preparar a planilha para rodar as macros automatizadas:</strong></p><ol style="margin-left: 20px; margin-bottom: 15px; line-height: 1.6;"><li>Abra a planilha da sua região.</li><li>Clique em <strong>"Exibir pasta de trabalho em tela inteira"</strong> (ícone de duas janelas no canto inferior direito).</li><li>Uma nova janela será aberta no Excel Online.</li><li>No menu superior, clique em <strong>Exibição</strong>.</li><li>Clique em <strong>"Abrir na área de trabalho"</strong>.</li></ol><p>Isso abrirá a planilha no Excel em sua versão desktop.</p><div class="video-container"><iframe width="560" height="315" src="https://www.youtube.com/embed/2uj-wwyg7YY" title="Habilitando Macros" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><p style="text-align: center; margin-top: 10px;"><a href="https://youtu.be/2uj-wwyg7YY" target="_blank" style="color: var(--senac-blue); font-size: 0.9rem; font-weight: bold; text-decoration: underline;"><i class="fab fa-youtube"></i> Caso não carregue, assista aqui</a></p><p style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px;"><em>Vídeo tutorial: Passo a passo no Excel</em></p><p style="color: var(--senac-green); font-weight: bold; margin-top: 20px; border-left: 4px solid var(--senac-green); padding-left: 10px; background: #f0fdf4; padding: 10px;"><i class="fas fa-check-circle"></i> Pronto!<br>A planilha estará pronta para rodar as macros de forma automatizada.</p><div class="warning-box" style="margin-top: 20px; display: block;"><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #c2410c;"><i class="fas fa-exclamation-triangle" style="font-size: 1.2rem;"></i><strong>! Atenção !</strong></div><p style="margin-bottom: 5px;">Caso apareça alguma mensagem de erro ao tentar rodar as macros, siga estas etapas:</p><ol style="margin-left: 20px; margin-top: 5px;"><li>Clique em <strong>Arquivo</strong> no canto superior esquerdo.</li><li>Selecione <strong>Central de Confiabilidade</strong>.</li><li>Clique em <strong>Configurações da Central de Confiabilidade</strong>.</li><li>Vá até <strong>Configurações de Macro</strong> e marque a opção <strong>“Habilitar macros VBA”</strong>.</li><li>Clique em <strong>OK</strong> para confirmar.</li></ol></div>` },
            3: { title: "Download de Documentos", subtitle: "Fase 1: Materiais de Apoio", text: "Aqui você encontra todos os arquivos padronizados necessários para o processo de supervisão. Certifique-se de baixar a versão mais recente dos manuais e formulários antes de iniciar as visitas." },
            4: { title: "Planilha de Planejamento", subtitle: "Fase 1: Organização", text: "A planilha central onde todas as visitas são agendadas e monitoradas. Mantenha este documento sempre atualizado para que a coordenação regional possa acompanhar o progresso em tempo real." },
            5: { title: "Configuração das Abas", subtitle: "Fase 1: Setup", text: "Antes de inserir dados, renomeie as abas conforme a nomenclatura padrão (ex: Cidade/Mês) para manter o histórico organizado." },
            6: { title: "Montar Logística", subtitle: "Fase 2: Roteirização", text: `<p>Planeje os horários e o roteiro das visitas agrupando empresas próximas geograficamente. Essa estratégia otimiza o tempo de deslocamento, reduz custos operacionais e torna a agenda mais eficiente. Utilize ferramentas de mapa sempre que necessário para apoiar o planejamento.</p><p style="margin-top: 15px;">Em seguida, entre em contato com as empresas para confirmar as seguintes informações: nome do jovem aprendiz, horário de trabalho, contraturno escolar e endereço da empresa. Essa verificação garante que a visita seja realizada conforme o planejamento estabelecido.</p><p style="text-align: center; margin-top: 20px;"><a href="https://leobaurdossantos.wixsite.com/rota-f" target="_blank" style="color: var(--senac-blue); font-weight: bold; text-decoration: underline;"><i class="fas fa-external-link-alt"></i> Acessar Site Rota Fácil</a></p><div class="video-container" style="margin-top: 10px;"><iframe width="560" height="315" src="https://www.youtube.com/embed/rfAOQMPZp7w" title="Rota Fácil" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><p style="text-align: center; margin-top: 10px;"><a href="https://youtu.be/rfAOQMPZp7w" target="_blank" style="color: var(--senac-blue); font-size: 0.9rem; font-weight: bold; text-decoration: underline;"><i class="fab fa-youtube"></i> Caso não carregue, assista aqui</a></p><p style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px;"><em>Rota Fácil o aplicativo para criar as melhores rotas</em></p>` },
            7: { title: "Aprovação da Agenda", subtitle: "Fase 2: Validação", text: "Após montar o roteiro preliminar, sinalize para o Polo-PR e Polo atuante e aguarde o 'De Acordo' antes de prosseguir com as visitas." },
            8: { title: "Abertura de Viagem", subtitle: "Fase 2: Administrativo", text: "Com a agenda aprovada, inicie o processo administrativo de solicitação de viagem (adiantamento, veículo, hospedagem) conforme as normas internas do Senac PR." },
            9: { title: "Confirmação com Empresas", subtitle: "Fase 2: Agendamento", text: "Entre em contato com os supervisores nas empresas para confirmar data, hora, endereço, nome e horário do jovem e contraturno escolar. Envie e-mails formais de confirmação para registrar o compromisso." },
            10: { title: "Formulário e/ou ATA", subtitle: "Fase 3: Preparação", text: "Certifique-se de ter em mãos o formulário de supervisão correto para a realização da visita. Caso necessário tenha em mãos a ATA para registro de situações que fogem do âmbito Formulário." },
            11: { title: "Preenchimento Inicial", subtitle: "Fase 3: Dados Básicos", text: "Para otimizar o tempo durante a visita, preencha previamente o cabeçalho do formulário com os dados da empresa, do aprendiz, do curso, do supervisor e a data. Certifique-se de que todos os campos estejam devidamente preenchidos, evitando deixar informações em branco. Além disso, garanta que todas as vias do documento sejam assinadas pelos participantes, assegurando a validade e a conformidade do registro." },
            12: { title: "Relatório de Desempenho", subtitle: "Fase 3: Análise Prévia", text: "Consulte o dashboard de desempenho do aluno. Verifique notas, frequência e ocorrências anteriores para ter embasamento durante a conversa com o supervisor da empresa." },
            13: { title: "A Entrevista", subtitle: "Fase 3: Ação", text: "Este é o momento central da visita. Converse inicialmente com o supervisor da empresa sobre a evolução do(a) aprendiz e, na sequência, com o próprio aprendiz. Registre de forma clara os pontos fortes, os pontos de melhoria e as situações ocorridas ao longo do período de prática. <br><br><strong>Lembre-se:</strong> sempre que necessário, utilize o documento <strong>ATA</strong> para formalizar os registros que fogem do âmbito Formulário." },
            14: { title: "Digitalização e Envio", subtitle: "Fase 4: Documentação", text: "Após a visita, digitalize o formulário assinado. Salve o arquivo seguindo o padrão de nomenclatura (Turma + Nome do Aluno) e faça o upload na pasta segura da região correspondente." },
            15: { title: "Registro na Planilha", subtitle: "Fase 4: Atualização de Status", text: "Retorne à planilha de planejamento e atualize o status da visita para 'Realizada', para efetuar o envio do e-mail de agradecimento e foto de registro da visita. Insira observações sucintas sobre o resultado da supervisão caso necessário na aba de dados gerais." },
            16: { title: "Informações para Rateio", subtitle: "Fase 4: Gestão e Controle", text: `<p style="margin-bottom: 15px;">Após finalizar as visitas programadas, siga as orientações abaixo:</p><p>Acesse a aba de planejamento da planilha e preencha todos os dados referentes ao dia de visitas.</p><strong style="display:block; margin-top: 15px; color: var(--senac-blue);">Registre as seguintes informações:</strong><ul style="margin-left: 20px; list-style-type: disc; margin-bottom: 20px;"><li>Data da visita;</li><li>Cidades de deslocamento;</li><li>Horários de cada visita realizada;</li><li>Horário de almoço;</li><li>Quilometragem (Km) percorrida entre as cidades visitadas;</li><li>Valor de pedágio, se houver.</li></ul><div class="warning-box" style="border-left: 4px solid var(--senac-blue); background-color: #eff6ff; display: block;"><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: var(--senac-blue);"><i class="fas fa-info-circle" style="font-size: 1.2rem;"></i><strong>Atenção à fidelidade das informações:</strong></div><p>Esses dados serão utilizados para o preenchimento das informações para fins de rateio. Por isso, é fundamental que todas as informações registradas estejam fidedignas à realidade.</p></div><p style="margin-top: 20px;"><strong>Após concluir o preenchimento:</strong></p><p>Sinalize o Polo-PR para que as informações sejam conferidas e, posteriormente, enviadas por e-mail ao supervisor e ao polo participante.</p>` },
            17: { title: "Envio Malote", subtitle: "Fase 4: Logística Física", text: `<h3 style="color: var(--senac-dark-blue); font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Encaminhamento de documentos para fechamento mensal</h3><p style="margin-bottom: 20px;">Ao finalizar todos os processos citados anteriormente, para o fechamento do mês, o polo atuante deverá encaminhar de forma física todos os documentos utilizados durante as visitas, para fins de arquivamento, seguindo as etapas abaixo:</p><div style="background-color: #f8fafc; border-radius: 8px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 20px;"><div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;"><div style="background: var(--senac-orange); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; font-weight: bold;">1</div><div><strong style="color: var(--senac-blue); display: block; margin-bottom: 5px;">Conferência da documentação:</strong><p style="font-size: 0.95rem; color: #4b5563;">Certifique-se de que todos os documentos estejam completos, devidamente preenchidos e assinados.</p></div></div><div style="display: flex; align-items: flex-start; gap: 12px;"><div style="background: var(--senac-orange); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; font-weight: bold;">2</div><div><strong style="color: var(--senac-blue); display: block; margin-bottom: 5px;">Envio da documentação:</strong><p style="font-size: 0.95rem; color: #4b5563;">Encaminhe os documentos via malote para <strong>Senac Portão (Curitiba)</strong>.</p></div></div></div><div style="background-color: #eff6ff; border-left: 4px solid var(--senac-blue); padding: 15px; border-radius: 4px;"><p style="font-size: 0.9rem; color: #1e3a8a; margin: 0;"><i class="fas fa-user-tag" style="margin-right: 8px;"></i><strong>Aos cuidados de:</strong> Michel Vieira Farias – EAD.</p></div>` },
            18: { title: "Conclusão do Ciclo", subtitle: "Fase 4: Fechamento", text: "Com todos os passos anteriores concluídos, sinalize ao Polo-PR o fechamento do ciclo de visitas do mês. O processo está finalizado!" }
        };

        function openStepInfo(stepId) {
            const data = stepData[stepId];
            if (data) {
                document.getElementById('step-modal-title').innerText = data.title;
                document.getElementById('step-modal-subtitle').innerText = data.subtitle;
                document.getElementById('step-modal-content').innerHTML = data.text;
                document.getElementById('step-detail-modal').classList.add('active');
            }
        }

        function closeStepInfo() { document.getElementById('step-detail-modal').classList.remove('active'); }
        document.getElementById('step-detail-modal').addEventListener('click', function(e) { if (e.target === this) closeStepInfo(); });

        // ==========================================
        // LÓGICA DO NOVO PAINEL BI (DADOS)
        // ==========================================
        let biDb = { qualificacao: [], tecnico: [] };
        let biCurrentScope = 'qualificacao';
        
        let biFinancialChart = null;

        const PREDEFINED_REGIONS = [
            "APUCARANA", "CAMPO MOURÃO", "CASCAVEL", "CASTRO", "CORNÉLIO PROCÓPIO", "CURITIBA", 
            "FOZ DO IGUAÇU", "FRANCISCO BELTRÃO", "GUARAPUAVA", "IRATI", "IVAIPORÃ", 
            "JACAREZINHO", "LONDRINA", "MARINGÁ", "MATINHOS", "MEDIANEIRA", "PARANAGUÁ", 
            "PARANAVAÍ", "PATO BRANCO", "PONTA GROSSA", "PRUDENTÓPOLIS", "RIO NEGRO", 
            "SANTO ANTÔNIO DA PLATINA", "TOLEDO", "UMUARAMA", "UNIÃO DA VITÓRIA"
        ];

        const DEFAULT_BI_USERS = [
            { name: 'Gestor Geral', region: '', email: 'gestor@senac.br' }
        ];

        let biCurrentUser = null;
        let biUsers = [];
        let biFilteredData = [];
        let biCurrentPage = 1;
        const biItemsPerPage = 50;
        let biChartStatusInstance = null;
        let biChartRegiaoInstance = null;
        let biCurrentStatusFilter = 'all';

        // --- 1. LÓGICA DE ABAS (ESCOPO E FINANCEIRO) ---

        function switchBiTab(tabName) {
            const viewDash = document.getElementById('biViewDashboard');
            const viewFin = document.getElementById('biViewFinanceiro');
            
            document.getElementById('biTabQualificacao').classList.remove('active');
            document.getElementById('biTabTecnico').classList.remove('active');
            document.getElementById('biTabFinanceiro').classList.remove('active');

            if (tabName === 'financeiro') {
                document.getElementById('biTabFinanceiro').classList.add('active');
                viewDash.classList.add('hidden');
                viewFin.classList.remove('hidden');
                viewFin.classList.add('flex');
                
                setTimeout(updateBiFinancials, 100);
            } else {
                biCurrentScope = tabName;
                if(tabName === 'qualificacao') document.getElementById('biTabQualificacao').classList.add('active');
                if(tabName === 'tecnico') document.getElementById('biTabTecnico').classList.add('active');
                
                viewDash.classList.remove('hidden');
                viewFin.classList.add('hidden');
                viewFin.classList.remove('flex');

                const daysLabel = biCurrentScope === 'tecnico' ? "120" : "90";
                const legendEl = document.getElementById('biLegendDelayedText');
                const kpiEl = document.getElementById('biKpiDelayedText');
                if(legendEl) legendEl.innerText = `Atrasado (> ${daysLabel} dias)`;
                if(kpiEl) kpiEl.innerText = `Fora do prazo de ${daysLabel} dias`;

                biCurrentPage = 1;
                populateBiFilters(); 
                applyBiFilters();
            }
        }

        // --- 2. GESTÃO FINANCEIRA ---

        function updateBiFinancials() {
            const budget = parseFloat(document.getElementById('biInputBudget').value) || 0;
            const costPerVisit = parseFloat(document.getElementById('biInputCost').value) || 0;

            let totalPending = 0;
            let regionStats = {};

            const processList = (list) => {
                list.forEach(item => {
                    const isEncerrado = item.fim && parseBiDate(item.fim) < new Date();
                    if (isEncerrado) return;

                    let pendingForStudent = 0;
                    item.visits.forEach(v => {
                        const status = (v.status || "").toLowerCase();
                        if (!status.includes("realizada") && !status.includes("concluída")) {
                            pendingForStudent++;
                        }
                    });

                    if (pendingForStudent > 0) {
                        totalPending += pendingForStudent;
                        const key = item.regiao || item.cidade || "Indefinido";
                        if (!regionStats[key]) regionStats[key] = 0;
                        regionStats[key] += pendingForStudent;
                    }
                });
            };

            processList(biDb.qualificacao || []);
            processList(biDb.tecnico || []);

            const projectedCost = totalPending * costPerVisit;
            const balance = budget - projectedCost;

            document.getElementById('biFinPendingVisits').innerText = totalPending;
            document.getElementById('biFinProjectedCost').innerText = formatBiCurrency(projectedCost);
            
            const elBalance = document.getElementById('biFinBalance');
            elBalance.innerText = formatBiCurrency(balance);
            elBalance.className = `text-4xl font-extrabold mb-2 ${balance >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            const elBadge = document.getElementById('biFinStatusBadge');
            if (balance >= 0) {
                elBadge.innerText = "Orçamento Suficiente";
                elBadge.className = "px-4 py-1 rounded-full text-xs font-bold uppercase bg-emerald-100 text-emerald-700";
            } else {
                elBadge.innerText = "Déficit Orçamentário";
                elBadge.className = "px-4 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-700";
            }

            updateBiFinancialChart(budget, projectedCost);
            updateBiFinancialTable(regionStats, costPerVisit, budget);
        }

        function formatBiCurrency(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function updateBiFinancialChart(budget, expenses) {
            const ctx = document.getElementById('biChartFinance');
            if (!ctx) return;
            if (biFinancialChart) biFinancialChart.destroy();

            biFinancialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Orçamento Disponível', 'Gastos Projetados'],
                    datasets: [{
                        label: 'Valor (R$)',
                        data: [budget, expenses],
                        backgroundColor: ['#10b981', expenses > budget ? '#ef4444' : '#3b82f6'],
                        borderRadius: 6,
                        barThickness: 60
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateBiFinancialTable(stats, costPerVisit, totalBudget) {
            const tbody = document.getElementById('biFinTableBody');
            tbody.innerHTML = '';
            const rows = Object.entries(stats).map(([region, visits]) => ({ region, visits, cost: visits * costPerVisit })).sort((a, b) => b.cost - a.cost);

            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400 text-xs">Nenhum dado pendente encontrado.</td></tr>`;
                return;
            }

            rows.forEach(row => {
                const percent = totalBudget > 0 ? (row.cost / totalBudget * 100).toFixed(1) : 0;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="p-4 font-medium text-slate-700">${row.region}</td>
                    <td class="p-4 text-center text-slate-600 bg-slate-50">${row.visits}</td>
                    <td class="p-4 text-right font-bold text-slate-700">${formatBiCurrency(row.cost)}</td>
                    <td class="p-4 text-center">
                        <div class="flex items-center gap-2 justify-center">
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-senac-blue" style="width: ${Math.min(percent, 100)}%"></div>
                            </div>
                            <span class="text-[10px] text-slate-500">${percent}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. INICIALIZAÇÃO E LOGIN ---

        function initBiUsers() {
            try {
                const stored = localStorage.getItem('senacSupervisors');
                if (stored && stored !== '[]') { biUsers = JSON.parse(stored); } 
                else { biUsers = [...DEFAULT_BI_USERS]; localStorage.setItem('senacSupervisors', JSON.stringify(biUsers)); }
            } catch (e) { biUsers = [...DEFAULT_BI_USERS]; }
            populateBiLoginRegions();
        }

        function populateBiLoginRegions() {
            const loginSel = document.getElementById('biLoginRegion');
            let options = '';
            PREDEFINED_REGIONS.forEach(r => { options += `<option value="${r}">${r}</option>`; });
            if(loginSel) loginSel.innerHTML = '<option value="">Acesso Geral (Todas as Regiões)</option>' + options;
        }

        function toggleBiLoginMethod() {
            const region = document.getElementById('biLoginRegion').value;
            const emailContainer = document.getElementById('biEmailContainer');
            const passwordContainer = document.getElementById('biPasswordContainer');

            if (region === "") { 
                emailContainer.classList.add('hidden');
                passwordContainer.classList.remove('hidden');
            } else { 
                emailContainer.classList.remove('hidden');
                passwordContainer.classList.add('hidden');
            }
        }

        function performBiLogin() {
            const region = document.getElementById('biLoginRegion').value;
            if (region === "") {
                const password = document.getElementById('biLoginPassword').value;
                if (password === "supervisao2026") {
                    biCurrentUser = { name: "Gestão Central", region: "", email: "admin@senac.br" };
                    startBiLoadingSequence();
                } else {
                    alert("Senha de acesso geral incorreta.");
                }
            } else {
                const email = document.getElementById('biLoginEmail').value.trim().toLowerCase();
                if (!email) return alert("Por favor, digite seu e-mail.");
                biCurrentUser = { name: "Supervisor Regional", region: region, email: email };
                startBiLoadingSequence();
            }
        }

        function startBiLoadingSequence() {
            document.getElementById('biLoginPage').style.display = 'none';
            document.getElementById('biGlobalLoader').classList.remove('hidden');
            document.getElementById('biLoadingMessage').innerText = "Validando credenciais e permissões...";

            setTimeout(() => {
                finishBiLogin();
            }, 1000);
        }

        function finishBiLogin() {
            const displayRegion = biCurrentUser.region || "Acesso Geral";
            document.getElementById('biDisplayUserName').innerText = biCurrentUser.name;
            document.getElementById('biDisplayUserRegion').innerText = displayRegion;
            
            if (displayRegion !== "Acesso Geral" && displayRegion !== "") {
                const filterReg = document.getElementById('biFilterRegiao');
                if (filterReg) {
                    filterReg.value = displayRegion;
                    filterReg.disabled = true; 
                    handleBiRegionChange(); 
                    document.getElementById('biRegionLockMsg').classList.remove('hidden');
                }
            }

            document.getElementById('biLoadingMessage').innerText = "Carregando dados do sistema...";
            tryLoadBiDefault();
        }

        function logoutBi() {
             document.getElementById('biAppContainer').classList.add('hidden');
             document.getElementById('biAppContainer').classList.remove('flex');
             document.getElementById('biLoginPage').style.display = 'flex';
             document.getElementById('biLoginPassword').value = '';
        }

        function resetBiUsersToDefault() {
             localStorage.removeItem('senacSupervisors');
             location.reload();
        }

        // --- 4. PROCESSAMENTO DE ARQUIVOS (Excel) ---

        async function tryLoadBiDefault() {
            document.getElementById('biLoadingMessage').innerText = "Buscando arquivos de dados...";
            
            const candidates = ["Dados Gerais.xlsm", "Dados Gerais.xlsx", "dados gerais.xlsx"];
            let fileFound = false;

            for (const filename of candidates) {
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const blob = await response.blob();
                        const file = new File([blob], filename);
                        processBiFile({ files: [file] }); // Chama processamento
                        fileFound = true;
                        break; 
                    }
                } catch (e) { }
            }

            if (!fileFound) {
                finalizeBiLoading();
            }
        }

        function processBiFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('biGlobalLoader').classList.remove('hidden');
            document.getElementById('biLoadingMessage').innerText = `Lendo arquivo: ${file.name}...`;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        document.getElementById('biLoadingMessage').innerText = "Processando planilhas e fórmulas...";
                        
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        let sheetQuali = workbook.SheetNames.find(n => n.trim().toLowerCase() === "dados gerais");
                        if(!sheetQuali) sheetQuali = workbook.SheetNames.find(n => n.toLowerCase().includes("dados gerais") && !n.toLowerCase().includes("tec"));
                        let sheetTec = workbook.SheetNames.find(n => n.toLowerCase().includes("dados gerais") && (n.toLowerCase().includes("tec") || n.toLowerCase().includes("téc")));
                        if(!sheetQuali && !sheetTec) sheetQuali = workbook.SheetNames[0];

                        biDb.qualificacao = [];
                        biDb.tecnico = [];

                        if (sheetQuali) biDb.qualificacao = parseBiSheet(workbook.Sheets[sheetQuali]);
                        if (sheetTec) biDb.tecnico = parseBiSheet(workbook.Sheets[sheetTec]);

                        document.getElementById('biLoadingMessage').innerText = "Finalizando visualização...";
                        switchBiTab(biCurrentScope);
                        
                        const btnText = document.getElementById('biBtnUploadText');
                        if(btnText) btnText.innerText = "Atualizado";

                        finalizeBiLoading();

                    } catch(e) {
                        console.error(e);
                        alert("Erro ao processar arquivo. Verifique o formato.");
                        finalizeBiLoading();
                    }
                }, 500);
            };
            reader.readAsArrayBuffer(file);
        }

        function finalizeBiLoading() {
            const loader = document.getElementById('biGlobalLoader');
            const app = document.getElementById('biAppContainer');

            loader.classList.add('transition-opacity', 'duration-500', 'opacity-0');
            
            setTimeout(() => {
                loader.classList.add('hidden');
                loader.classList.remove('opacity-0'); 
                
                app.classList.remove('hidden');
                app.classList.add('flex');
                setTimeout(() => {
                    app.classList.remove('opacity-0');
                }, 50);
            }, 500);
        }

        function parseBiSheet(worksheet) {
            const json = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});
            if(json.length < 2) return [];
            const headers = json[0].map(h => String(h).trim());
            const getIdx = (candidates) => {
                for(let c of candidates) {
                    const i = headers.findIndex(h => h.toLowerCase().includes(c.toLowerCase()));
                    if(i > -1) return i;
                }
                return -1;
            }

            const map = {
                nome: getIdx(["Apr. Nome", "Nome", "Jovem"]),
                turma: getIdx(["Turma", "Matrícula"]),
                curso: getIdx(["Curso", "Nome do Curso"]), 
                hrTeoria: getIdx(["Teoria Hr Ini", "Horario Teoria"]),
                hrPratica: getIdx(["Horário do jovem", "Pratica Hr Ini"]),
                cidade: getIdx(["Emp. Cidade"]),
                regiao: getIdx(["Atuação Senac", "Região"]),
                empresa: getIdx(["Razao Social", "Empresa"]),
                supNome: getIdx(["Sup. Cadastrado", "Supervisor"]),
                supEmpresa: getIdx(["Sup. na Empresa"]),
                supCel: getIdx(["Sup Celular", "Contato"]),
                supEmail: getIdx(["Sup. Email", "Email Supervisor"]), 
                dtIni: getIdx(["TurDatIni"]),
                dtFim: getIdx(["TurDatFim"]),
                v1Dt: getIdx(["Data da Visita 1"]),
                v1St: getIdx(["Status Visita 1"]),
                v2Dt: getIdx(["Data da Visita 2"]),
                v2St: getIdx(["Status Visita"]), 
                v3Dt: getIdx(["Data da Visita 3"]),
                v3St: getIdx(["Status Visita"])
            };

            return json.slice(1).map((row, i) => {
                if(!row[map.nome]) return null;
                const idxV2St = map.v2Dt > -1 ? map.v2Dt + 1 : -1; 
                const idxV3St = map.v3Dt > -1 ? map.v3Dt + 1 : -1;
                return {
                    id: i,
                    nome: String(row[map.nome]).trim(),
                    turma: String(row[map.turma] || "N/A"),
                    cidade: row[map.cidade] || "N/A",
                    regiao: row[map.regiao] || "Geral",
                    empresa: row[map.empresa],
                    supervisor: {
                        nome: row[map.supNome] || "Não inf.",
                        cel: row[map.supCel] || "",
                        email: row[map.supEmail] || "" 
                    },
                    inicio: parseBiDate(row[map.dtIni]),
                    fim: parseBiDate(row[map.dtFim]),
                    visits: [
                        { date: parseBiDate(row[map.v1Dt]), status: String(row[map.v1St]).trim(), label: "1ª" },
                        { date: parseBiDate(row[map.v2Dt]), status: String(row[idxV2St] || row[map.v2St]).trim(), label: "2ª" },
                        { date: parseBiDate(row[map.v3Dt]), status: String(row[idxV3St] || row[map.v3St]).trim(), label: "3ª" }
                    ],
                    hrTeoria: formatBiTime(row[map.hrTeoria]),
                    hrPratica: formatBiTime(row[map.hrPratica])
                };
            }).filter(x => x);
        }

        // --- 5. HELPERS ---

        function parseBiDate(val) {
            if(!val) return null;
            if(val instanceof Date) return val;
            if(typeof val === 'number') {
                const date = new Date(Math.round((val - 25569)*86400*1000));
                return new Date(date.getTime() + date.getTimezoneOffset()*60000);
            }
            if(typeof val === 'string') {
                val = val.trim();
                if(val.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y,m,d] = val.split('-'); return new Date(y, m-1, d);
                }
                if(val.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [d,m,y] = val.split('/'); return new Date(y, m-1, d);
                }
            }
            return null;
        }

        function formatBiTime(val) {
            if (!val) return "";
            if (typeof val === 'number') {
                const totalSeconds = Math.round(val * 86400);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            return val;
        }

        function analyzeBiJovem(jovem) {
            const isEncerrado = jovem.fim && jovem.fim < new Date();
            let globalStatus = "No Prazo";
            let globalColor = "green"; 
            if (isEncerrado) return { ...jovem, processedVisits: jovem.visits, globalStatus: "Encerrado", globalColor: "gray", isEncerrado };

            let lastReferenceDate = jovem.inicio;
            let visitsDoneCount = 0;
            const processedVisits = jovem.visits.map(v => {
                let state = "pending";
                const isRealizada = v.status.toLowerCase().includes("realizada");
                if (isRealizada) {
                    state = "done";
                    visitsDoneCount++;
                    if (v.date) lastReferenceDate = v.date;
                }
                return { ...v, state };
            });

            if (visitsDoneCount === 3) return { ...jovem, processedVisits, globalStatus: "Concluído", globalColor: "blue", isEncerrado };
            if (!lastReferenceDate) return { ...jovem, processedVisits, globalStatus: "Sem Data Ini", globalColor: "gray", isEncerrado };

            const deadline = new Date(lastReferenceDate);
            const daysToAdd = biCurrentScope === 'tecnico' ? 120 : 90;
            deadline.setDate(deadline.getDate() + daysToAdd);
            
            if (new Date() > deadline) { globalStatus = "Atrasado"; globalColor = "red"; }

            return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
        }

        // --- 6. RENDERIZAÇÃO DASHBOARD ---

        function populateBiFilters() {
            const selReg = document.getElementById('biFilterRegiao');
            if(!selReg) return;

            const currentData = biDb[biCurrentScope] || [];
            const fileRegions = [...new Set(currentData.map(i => i.regiao))].filter(Boolean);
            const allRegions = [...new Set([...PREDEFINED_REGIONS, ...fileRegions])].sort();
            
            if (biCurrentUser && biCurrentUser.region) {
                selReg.innerHTML = `<option value="${biCurrentUser.region}">${biCurrentUser.region}</option>`;
                selReg.value = biCurrentUser.region;
                selReg.disabled = true;
                const lockMsg = document.getElementById('biRegionLockMsg');
                if(lockMsg) lockMsg.classList.remove('hidden');
                updateBiCityOptions(biCurrentUser.region); 
            } else {
                selReg.innerHTML = '<option value="">Todas as Regiões</option>';
                allRegions.forEach(r => selReg.innerHTML += `<option value="${r}">${r}</option>`);
                selReg.disabled = false;
                const lockMsg = document.getElementById('biRegionLockMsg');
                if(lockMsg) lockMsg.classList.add('hidden');
                updateBiCityOptions(""); 
            }
        }

        function handleBiRegionChange() {
            updateBiCityOptions(document.getElementById('biFilterRegiao').value);
            applyBiFilters();
        }

        function updateBiCityOptions(region) {
            const selCid = document.getElementById('biFilterCidade');
            if(!selCid) return;
            const currentVal = selCid.value;
            const currentData = biDb[biCurrentScope] || [];

            const availableCities = [...new Set(
                currentData
                    .filter(item => region === "" || item.regiao === region)
                    .map(item => item.cidade)
            )].filter(Boolean).sort();

            selCid.innerHTML = '<option value="">Todas as Cidades</option>';
            availableCities.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);
            if (availableCities.includes(currentVal)) selCid.value = currentVal;
        }

        function filterBiByStatus(status) {
            biCurrentStatusFilter = status;
            applyBiFilters();
        }

        function applyBiFilters() {
            const search = document.getElementById('biFilterSearch').value.toLowerCase();
            const regiao = document.getElementById('biFilterRegiao').value;
            const cidade = document.getElementById('biFilterCidade').value;
            const contractStatus = document.getElementById('biFilterContractStatus').value;

            biFilteredData = (biDb[biCurrentScope] || []).map(analyzeBiJovem).filter(item => {
                const nameMatch = item.nome && item.nome.toLowerCase().includes(search);
                const classMatch = item.turma && item.turma.toLowerCase().includes(search);
                if(search && !nameMatch && !classMatch) return false;
                if(regiao && item.regiao !== regiao) return false;
                if(cidade && item.cidade !== cidade) return false;
                if (contractStatus === 'active' && item.isEncerrado) return false;
                if (contractStatus === 'closed' && !item.isEncerrado) return false;
                if(biCurrentStatusFilter === 'atrasado' && item.globalColor !== 'red') return false;
                if(biCurrentStatusFilter === 'noprazo' && item.globalColor !== 'green' && item.globalColor !== 'blue') return false;
                return true;
            });

            updateBiDashboard();
            renderBiTable();
        }

        function updateBiDashboard() {
            const countEl = document.getElementById('biCountFiltered');
            if(countEl) countEl.innerText = biFilteredData.length;
            
            const total = biFilteredData.length;
            const atrasados = biFilteredData.filter(i => i.globalColor === 'red').length;
            const noPrazo = biFilteredData.filter(i => i.globalColor === 'green' || i.globalColor === 'blue').length;

            document.getElementById('biKpiTotal').innerText = total;
            document.getElementById('biKpiAtrasados').innerText = atrasados;
            document.getElementById('biKpiNoPrazo').innerText = noPrazo;

            const ctxStatus = document.getElementById('biChartStatus');
            if(ctxStatus) {
                if(biChartStatusInstance) biChartStatusInstance.destroy();
                const statusCounts = { 'No Prazo': 0, 'Atrasado': 0, 'Concluído': 0, 'Encerrado': 0 };
                biFilteredData.forEach(i => {
                    if(i.globalColor === 'green') statusCounts['No Prazo']++;
                    else if(i.globalColor === 'red') statusCounts['Atrasado']++;
                    else if(i.globalColor === 'blue') statusCounts['Concluído']++;
                    else statusCounts['Encerrado']++;
                });

                biChartStatusInstance = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#10b981', '#ef4444', '#004587', '#94a3b8'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true, font: {family: 'Inter'} } } } }
                });
            }

            const ctxRegiao = document.getElementById('biChartRegiao');
            if(ctxRegiao) {
                if(biChartRegiaoInstance) biChartRegiaoInstance.destroy();
                const counts = {};
                const isRegiaoSelected = document.getElementById('biFilterRegiao').value !== "";
                biFilteredData.forEach(i => {
                    const key = isRegiaoSelected ? i.cidade : i.regiao;
                    counts[key] = (counts[key] || 0) + 1;
                });
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);

                biChartRegiaoInstance = new Chart(ctxRegiao, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(x => x[0]),
                        datasets: [{
                            label: 'Jovens',
                            data: sorted.map(x => x[1]),
                            backgroundColor: '#004587',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: {display: false} }, y: { grid: {display: false} } } }
                });
            }
        }

        function changeBiPage(delta) {
            biCurrentPage += delta;
            renderBiTable();
        }

        function renderBiTable() {
            const tbody = document.getElementById('biTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';

            if (biFilteredData.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="p-12 text-center text-slate-400">Nenhum registro encontrado.</td></tr>`;
                 return;
            }
            
            const totalPages = Math.ceil(biFilteredData.length / biItemsPerPage) || 1;
            if (biCurrentPage > totalPages) biCurrentPage = 1;
            if (biCurrentPage < 1) biCurrentPage = 1;

            const start = (biCurrentPage - 1) * biItemsPerPage;
            const end = start + biItemsPerPage;
            const pageData = biFilteredData.slice(start, end);

            document.getElementById('biPageDisplay').innerText = `${biCurrentPage} / ${totalPages}`;
            document.getElementById('biBtnPrev').disabled = biCurrentPage === 1;
            document.getElementById('biBtnNext').disabled = biCurrentPage === totalPages;

            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';

            pageData.forEach(item => {
                let visitsHtml = `<div class="flex gap-4 justify-center">`;
                item.processedVisits.forEach((v, idx) => {
                    let color = "bg-slate-200";
                    if(v.state === 'done') color = "bg-emerald-500 shadow-md shadow-emerald-200";
                    visitsHtml += `
                        <div class="flex flex-col items-center group relative cursor-help">
                            <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-white text-xs font-bold border border-white">
                                ${idx + 1}
                            </div>
                        </div>
                    `;
                });
                visitsHtml += `</div>`;

                let badgeClass = "bg-slate-100 text-slate-500";
                if(item.globalColor === 'green') badgeClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
                if(item.globalColor === 'red') badgeClass = "bg-red-100 text-red-700 border border-red-200";
                if(item.globalColor === 'blue') badgeClass = "bg-blue-100 text-blue-700 border border-blue-200";

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-700 text-sm">${item.nome}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-mono bg-blue-50 text-blue-600 border border-blue-100">${item.turma}</span>
                            <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${item.hrTeoria}</span>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs font-bold text-slate-700 truncate max-w-[150px]" title="${item.empresa}">${item.empresa}</div>
                        <div class="text-[10px] text-slate-400 mt-0.5 uppercase tracking-wide">${item.cidade}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs text-slate-600">
                            <div class="font-medium">${item.supervisor.nome}</div>
                            ${item.supervisor.cel ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5"><i data-lucide="phone" class="w-2.5 h-2.5"></i> ${item.supervisor.cel}</div>` : ''}
                        </div>
                    </td>
                    <td class="p-4 align-top text-center text-xs font-mono text-slate-500">
                        <div class="text-emerald-600">${formatDate(item.inicio)}</div>
                        <div class="text-slate-400 border-l h-2 mx-auto my-0.5 w-px"></div>
                        <div class="${item.isEncerrado ? 'text-red-400 line-through' : ''}">${formatDate(item.fim)}</div>
                    </td>
                    <td class="p-4 align-top">
                        ${visitsHtml}
                    </td>
                    <td class="p-4 align-top text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${badgeClass}">
                            ${item.globalStatus}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function exportBiReport() {
            if (biFilteredData.length === 0) return alert("Nenhum dado para exportar.");
            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';
            const exportData = [[
                "Nome do Jovem", "Turma", "Curso", "Horário", "Empresa", "Cidade", "Região",
                "Supervisor Senac", "Supervisor Empresa", "Celular Sup", "Email Sup", 
                "Data Início", "Data Fim", 
                "Status Geral"
            ]];
            biFilteredData.forEach(item => {
                exportData.push([
                    item.nome, item.turma, item.curso, item.hrTeoria, item.empresa, item.cidade, item.regiao,
                    item.supervisor.nome, item.supervisor.empresa, item.supervisor.cel, item.supervisor.email,
                    formatDate(item.inicio), formatDate(item.fim),
                    item.globalStatus
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Relatorio_${biCurrentScope}`);
            XLSX.writeFile(wb, `Relatorio_Senac_${biCurrentScope}.xlsx`);
        }

        // ==========================================
        // NOVA FUNÇÃO: CONEXÃO GEMINI (ASSÍNCRONA)
        // ==========================================
        async function conectarGemini() {
            const apiKeyInput = document.getElementById('geminiApiKey');
            const statusText = document.getElementById('geminiStatus');
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                statusText.innerText = "Por favor, insira uma API Key.";
                statusText.className = "text-[10px] text-red-500 mt-2 text-center font-bold";
                return;
            }

            statusText.innerText = "Conectando...";
            statusText.className = "text-[10px] text-blue-500 mt-2 text-center";

            try {
                if (window.GoogleGenerativeAI) {
                    const genAI = new window.GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    
                    // Teste simples
                    const prompt = "Diga 'Conexão estabelecida com sucesso' em português.";
                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    const text = response.text();

                    statusText.innerText = "Conectado! " + text;
                    statusText.className = "text-[10px] text-emerald-600 mt-2 text-center font-bold";
                } else {
                    throw new Error("Biblioteca Gemini não carregada.");
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "Erro ao conectar. Verifique a chave.";
                statusText.className = "text-[10px] text-red-500 mt-2 text-center font-bold";
            }
        }
    </script>
</body>
</html>
